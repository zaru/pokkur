(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb={}.hasOwnProperty,db=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},eb=function(a,b){function c(){this.constructor=a}for(var d in b)cb.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},fb=[].slice;if(x=function(){function a(){throw new Error("Not implemented. Did you mean to use Dropbox.Client?")}return a}(),x.Util=function(){function a(){}return a}(),x.Http=function(){function a(){}return a}(),x.File=function(){function a(){}return a}(),i="1.2.0","undefined"!=typeof global&&"undefined"!=typeof module&&"exports"in module)l=global,m=module.require.bind(module),module.exports=x;else if("undefined"!=typeof window&&"undefined"!=typeof navigator)l=window,m=null,window.Dropbox&&!function(){var a,b,c,d;c=window.Dropbox,d=[];for(a in c)cb.call(c,a)&&(b=c[a],d.push(x[a]=b));return d}(),window.Dropbox=x;else{if("undefined"==typeof self||"undefined"==typeof navigator)throw new Error("dropbox.js loaded in an unsupported JavaScript environment.");l=self,m=self.importScripts.bind(self),self.Dropbox=x}if(x.Env=function(){function a(){}return a.global=l,a.require=m,a}(),x.Util.EventSource=function(){function a(a){this._cancelable=a&&a.cancelable,this._listeners=[]}return a.prototype.addListener=function(a){if("function"!=typeof a)throw new TypeError("Invalid listener type; expected function");return db.call(this._listeners,a)<0&&this._listeners.push(a),this},a.prototype.removeListener=function(a){var b,c,d,e,f,g;if(this._listeners.indexOf)c=this._listeners.indexOf(a),-1!==c&&this._listeners.splice(c,1);else for(g=this._listeners,b=e=0,f=g.length;f>e;b=++e)if(d=g[b],d===a){this._listeners.splice(b,1);break}return this},a.prototype.dispatch=function(a){var b,c,d,e,f;for(f=this._listeners,d=0,e=f.length;e>d;d++)if(b=f[d],c=b(a),this._cancelable&&c===!1)return!1;return!0},a}(),x.AccountInfo=function(){function a(a){var b;this._json=a,this.name=a.display_name,this.email=a.email,this.countryCode=a.country||null,this.uid=a.uid.toString(),a.public_app_url?(this.publicAppUrl=a.public_app_url,b=this.publicAppUrl.length-1,b>=0&&"/"===this.publicAppUrl.substring(b)&&(this.publicAppUrl=this.publicAppUrl.substring(0,b))):this.publicAppUrl=null,this.referralUrl=a.referral_link,this.quota=a.quota_info.quota,this.privateBytes=a.quota_info.normal||0,this.sharedBytes=a.quota_info.shared||0,this.usedQuota=this.privateBytes+this.sharedBytes}return a.parse=function(a){return a&&"object"==typeof a?new x.AccountInfo(a):a},a.prototype.name=null,a.prototype.email=null,a.prototype.countryCode=null,a.prototype.uid=null,a.prototype.referralUrl=null,a.prototype.publicAppUrl=null,a.prototype.quota=null,a.prototype.usedQuota=null,a.prototype.privateBytes=null,a.prototype.sharedBytes=null,a.prototype.json=function(){return this._json},a}(),x.ApiError=function(){function a(a,b,c){var d,e;if(this.method=b,this.url=c,this.status=a.status,a.responseType)try{d=a.response||a.responseText}catch(f){e=f;try{d=a.responseText}catch(f){e=f,d=null}}else try{d=a.responseText}catch(f){e=f,d=null}if(d)try{this.responseText=d.toString(),this.response=JSON.parse(d)}catch(f){e=f,this.response=null}else this.responseText="(no response)",this.response=null}return a.prototype.status=null,a.prototype.method=null,a.prototype.url=null,a.prototype.responseText=null,a.prototype.response=null,a.NETWORK_ERROR=0,a.NO_CONTENT=304,a.INVALID_PARAM=400,a.INVALID_TOKEN=401,a.OAUTH_ERROR=403,a.NOT_FOUND=404,a.INVALID_METHOD=405,a.NOT_ACCEPTABLE=406,a.CONFLICT=409,a.RATE_LIMITED=429,a.SERVER_ERROR=503,a.OVER_QUOTA=507,a.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText},a.prototype.inspect=function(){return this.toString()},a}(),x.AuthDriver=function(){function a(){}return a.prototype.authType=function(){return"code"},a.prototype.url=function(){return"https://some.url"},a.prototype.doAuthorize=function(a,b,c,d){return d({code:"access-code"})},a.prototype.getStateParam=function(a,b){return b(x.Util.Oauth.randomAuthStateParam())},a.prototype.resumeAuthorize=function(a,b,c){return c({code:"access-code"})},a.prototype.onAuthStateChange=function(a,b){return b()},a.oauthQueryParams=["access_token","expires_in","scope","token_type","code","error","error_description","error_uri","mac_key","mac_algorithm"].sort(),a}(),x.AuthDriver.autoConfigure=function(a){if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id)return void a.authDriver(chrome.tabs&&chrome.tabs.create?new x.AuthDriver.ChromeExtension:new x.AuthDriver.ChromeApp);if("undefined"!=typeof window){if(window.cordova)return void a.authDriver(new x.AuthDriver.Cordova);window&&window.navigator&&a.authDriver(new x.AuthDriver.Redirect)}},x.AuthDriver.BrowserBase=function(){function a(a){a?(this.rememberUser="rememberUser"in a?a.rememberUser:!0,this.scope=a.scope||"default"):(this.rememberUser=!0,this.scope="default"),this.storageKey=null,this.storage=x.AuthDriver.BrowserBase.localStorage(),this.stateRe=/^[^#]+\#(.*&)?state=([^&]+)(&|$)/}return a.prototype.authType=function(){return"token"},a.prototype.onAuthStepChange=function(a,b){var c=this;switch(this.setStorageKey(a),a.authStep){case x.Client.RESET:return this.loadCredentials(function(d){return d?(a.setCredentials(d),a.authStep!==x.Client.DONE?b():c.rememberUser?(a.setCredentials(d),b()):c.forgetCredentials(b)):b()});case x.Client.DONE:return this.rememberUser?this.storeCredentials(a.credentials(),b):this.forgetCredentials(b);case x.Client.SIGNED_OUT:return this.forgetCredentials(b);case x.Client.ERROR:return this.forgetCredentials(b);default:return b(),this}},a.prototype.setStorageKey=function(a){return this.storageKey="dropbox-auth:"+this.scope+":"+a.appHash(),this},a.prototype.storeCredentials=function(a,b){var c,d,e,f;c=JSON.stringify(a);try{this.storage.setItem(this.storageKey,c)}catch(g){e=g,d=encodeURIComponent(this.storageKey),f=encodeURIComponent(c),document.cookie=""+d+"="+f+"; path=/"}return b(),this},a.prototype.loadCredentials=function(a){var b,c,d,e,f,g,h;try{d=this.storage.getItem(this.storageKey)}catch(i){h=i,d=null}if(null===d&&(f=encodeURIComponent(this.storageKey),g=f.replace(/[.*+()]/g,"\\$&"),b=new RegExp("(^|(;\\s*))"+f+"=([^;]*)(;|$)"),(e=b.exec(document.cookie))&&(d=decodeURIComponent(e[3]))),!d)return a(null),this;try{a(JSON.parse(d))}catch(i){c=i,a(null)}return this},a.prototype.forgetCredentials=function(a){var b,c,d;try{this.storage.removeItem(this.storageKey)}catch(e){d=e,c=encodeURIComponent(this.storageKey),b=new Date(0).toGMTString(),document.cookie=""+c+"={}; expires="+b+"; path=/"}return a(),this},a.prototype.locationStateParam=function(a){var b,c;return b=a||x.AuthDriver.BrowserBase.currentLocation(),c=this.stateRe.exec(b),c?decodeURIComponent(c[2]):null},a.prototype.replaceUrlBasename=function(a,b){var c,d,e;return d=a.indexOf("#"),-1!==d&&(a=a.substring(0,d)),e=a.indexOf("?"),-1!==e&&(a=a.substring(0,e)),c=a.split("/"),c[c.length-1]=b,c.join("/")},a.localStorage=function(){return"undefined"!=typeof window?window.localStorage:null},a.currentLocation=function(){return window.location.href},a.cleanupLocation=function(){var a,b;window.history&&window.history.replaceState?(b=this.currentLocation(),a=b.indexOf("#"),window.history.replaceState({},document.title,b.substring(0,a))):window.location.hash=""},a}(),x.AuthDriver.Redirect=function(a){function b(a){b.__super__.constructor.call(this,a),this.receiverUrl=this.baseUrl(a)}return eb(b,a),b.prototype.baseUrl=function(a){var b,c;if(c=x.AuthDriver.BrowserBase.currentLocation(),a){if(a.redirectUrl)return a.redirectUrl;if(a.redirectFile)return this.replaceUrlBasename(c,a.redirectFile)}return b=c.indexOf("#"),-1!==b&&(c=c.substring(0,b)),c},b.prototype.url=function(){return this.receiverUrl},b.prototype.doAuthorize=function(a,b,c){return this.storeCredentials(c.credentials(),function(){return window.location.assign(a)})},b.prototype.resumeAuthorize=function(a,b,c){var d;return this.locationStateParam()===a?(d=x.AuthDriver.BrowserBase.currentLocation(),x.AuthDriver.BrowserBase.cleanupLocation(),c(x.Util.Oauth.queryParamsFromUrl(d))):this.forgetCredentials(function(){return c({error:"Authorization error"})})},b}(x.AuthDriver.BrowserBase),x.AuthDriver.Popup=function(a){function b(a){b.__super__.constructor.call(this,a),this.receiverUrl=this.baseUrl(a)}return eb(b,a),b.prototype.url=function(){return this.receiverUrl},b.prototype.doAuthorize=function(a,b,c,d){return this.listenForMessage(b,d),this.openWindow(a)},b.prototype.baseUrl=function(a){var b;if(b=x.AuthDriver.BrowserBase.currentLocation(),a){if(a.receiverUrl)return a.receiverUrl;if(a.receiverFile)return this.replaceUrlBasename(b,a.receiverFile)}return b},b.prototype.openWindow=function(a){return window.open(a,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,700))},b.prototype.popupWindowSpec=function(a,b){var c,d,e,f,g,h,i,j,k,l;return g=null!=(i=window.screenX)?i:window.screenLeft,h=null!=(j=window.screenY)?j:window.screenTop,f=null!=(k=window.outerWidth)?k:document.documentElement.clientWidth,c=null!=(l=window.outerHeight)?l:document.documentElement.clientHeight,d=Math.round(g+(f-a)/2),e=Math.round(h+(c-b)/2.5),g>d&&(d=g),h>e&&(e=h),"width="+a+",height="+b+","+("left="+d+",top="+e)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"},b.prototype.listenForMessage=function(a,b){var c,d=this;return c=function(e){var f,g,h;f=e.data?e.data:e;try{h=JSON.parse(f)._dropboxjs_oauth_info}catch(i){return void(g=i)}return h&&d.locationStateParam(h)===a?(a=!1,window.removeEventListener("message",c),x.AuthDriver.Popup.onMessage.removeListener(c),b(x.Util.Oauth.queryParamsFromUrl(f))):void 0},window.addEventListener("message",c,!1),x.AuthDriver.Popup.onMessage.addListener(c)},b.locationOrigin=function(a){var b;return(b=/^(file:\/\/[^\?\#]*)(\?|\#|$)/.exec(a))?b[1]:(b=/^([^\:]+\:\/\/[^\/\?\#]*)(\/|\?|\#|$)/.exec(a),b?b[1]:a)},b.oauthReceiver=function(){window.addEventListener("load",function(){var a,b,c,d,e,f;if(f=window.location.href,c=JSON.stringify({_dropboxjs_oauth_info:f}),x.AuthDriver.BrowserBase.cleanupLocation(),d=window.opener,window.parent!==window.top&&(d||(d=window.parent)),d){try{e=window.location.origin||locationOrigin(f),d.postMessage(c,e),window.close()}catch(g){b=g}try{return d.Dropbox.AuthDriver.Popup.onMessage.dispatch(c),window.close()}catch(g){a=g}}})},b.onMessage=new x.Util.EventSource,b}(x.AuthDriver.BrowserBase),x.AuthDriver.ChromeBase=function(a){function b(a){b.__super__.constructor.call(this,a),this.storageKey="dropbox_js_"+this.scope+"_credentials"}return eb(b,a),b.prototype.onAuthStepChange=function(a,b){switch(a.authStep){case x.Client.RESET:return this.loadCredentials(function(c){return c&&a.setCredentials(c),b()});case x.Client.DONE:return this.storeCredentials(a.credentials(),b);case x.Client.SIGNED_OUT:return this.forgetCredentials(b);case x.Client.ERROR:return this.forgetCredentials(b);default:return b()}},b.prototype.url=function(){return this.receiverUrl},b.prototype.storeCredentials=function(a,b){var c;return c={},c[this.storageKey]=a,chrome.storage.local.set(c,b),this},b.prototype.loadCredentials=function(a){var b=this;return chrome.storage.local.get(this.storageKey,function(c){return a(c[b.storageKey]||null)}),this},b.prototype.forgetCredentials=function(a){return chrome.storage.local.remove(this.storageKey,a),this},b}(x.AuthDriver.BrowserBase),x.AuthDriver.ChromeApp=function(a){function b(a){b.__super__.constructor.call(this,a),this.receiverUrl="https://"+chrome.runtime.id+".chromiumapp.org/"}return eb(b,a),b.prototype.doAuthorize=function(a,b,c,d){var e=this;return chrome.identity.launchWebAuthFlow({url:a,interactive:!0},function(a){return e.locationStateParam(a)===b?(b=!1,d(x.Util.Oauth.queryParamsFromUrl(a))):void 0})},b}(x.AuthDriver.ChromeBase),x.AuthDriver.ChromeExtension=function(a){function b(a){var c;b.__super__.constructor.call(this,a),c=a&&a.receiverPath||"chrome_oauth_receiver.html",this.receiverUrl=chrome.runtime.getURL(c)}return eb(b,a),b.prototype.doAuthorize=function(a,b,c,d){var e,f,g=this;return f=null,e=function(a,c){var h;return c&&c.tab&&c.tab.url.substring(0,g.receiverUrl.length)!==g.receiverUrl||!a.dropbox_oauth_receiver_href?void 0:(h=a.dropbox_oauth_receiver_href,g.locationStateParam(h)===b?(b=!1,f&&chrome.tabs.remove(f.id),chrome.runtime.onMessage.removeListener(e),d(x.Util.Oauth.queryParamsFromUrl(h))):void 0)},chrome.runtime.onMessage.addListener(e),chrome.tabs.create({url:a,active:!0,pinned:!1},function(a){return f=a})},b.oauthReceiver=function(){return window.addEventListener("load",function(){var a;return a=window.location.href,window.location.hash="",chrome.runtime.sendMessage({dropbox_oauth_receiver_href:a}),window.close?window.close():void 0})},b}(x.AuthDriver.ChromeBase),x.AuthDriver.Cordova=function(a){function b(a){b.__super__.constructor.call(this,a)}return eb(b,a),b.prototype.url=function(){return"https://www.dropbox.com/1/oauth2/redirect_receiver"},b.prototype.doAuthorize=function(a,b,c,d){var e,f,g,h,i,j=this;return f=window.open(a,"_blank","location=yes,closebuttoncaption=Cancel"),h=!1,e=/^[^/]*\/\/[^/]*\//.exec(a)[0],i=!1,g=function(a){if(a.url&&j.locationStateParam(a.url)===b){if(i)return;return f.removeEventListener("loadstart",g),f.removeEventListener("loaderror",g),f.removeEventListener("loadstop",g),f.removeEventListener("exit",g),i=!0,window.setTimeout(function(){return f.close()},10),void d(x.Util.Oauth.queryParamsFromUrl(a.url))}if("exit"===a.type){if(i)return;f.removeEventListener("loadstart",g),f.removeEventListener("loaderror",g),f.removeEventListener("loadstop",g),f.removeEventListener("exit",g),i=!0,d(new AuthError("error=access_denied&error_description=User+closed+browser+window"))}},f.addEventListener("loadstart",g),f.addEventListener("loaderror",g),f.addEventListener("loadstop",g),f.addEventListener("exit",g)},b}(x.AuthDriver.BrowserBase),x.AuthDriver.NodeServer=function(){function a(a){this._port=(null!=a?a.port:void 0)||8912,(null!=a?a.tls:void 0)?(this._tlsOptions=a.tls,("string"==typeof this._tlsOptions||this._tlsOptions instanceof Buffer)&&(this._tlsOptions={key:this._tlsOptions,cert:this._tlsOptions})):this._tlsOptions=null,this._fs=x.Env.require("fs"),this._http=x.Env.require("http"),this._https=x.Env.require("https"),this._open=x.Env.require("open"),this._callbacks={},this._nodeUrl=x.Env.require("url"),this.createApp()}return a.prototype.authType=function(){return"code"},a.prototype.url=function(){var a;return a=null===this._tlsOptions?"http":"https",""+a+"://localhost:"+this._port+"/oauth_callback"},a.prototype.doAuthorize=function(a,b,c,d){return this._callbacks[b]=d,this.openBrowser(a)},a.prototype.openBrowser=function(a){if(!a.match(/^https?:\/\//))throw new Error("Not a http/https URL: "+a);return"BROWSER"in process.env?this._open(a,process.env.BROWSER):this._open(a)},a.prototype.createApp=function(){var a=this;return this._app=this._tlsOptions?this._https.createServer(this._tlsOptions,function(b,c){return a.doRequest(b,c)}):this._http.createServer(function(b,c){return a.doRequest(b,c)}),this._app.listen(this._port)},a.prototype.closeServer=function(){return this._app.close()},a.prototype.doRequest=function(a,b){var c,d,e,f=this;return e=this._nodeUrl.parse(a.url,!0),"/oauth_callback"===e.pathname&&(d=e.query.state,this._callbacks[d]&&(this._callbacks[d](e.query),delete this._callbacks[d])),c="",a.on("data",function(a){return c+=a}),a.on("end",function(){return f.closeBrowser(b)})},a.prototype.closeBrowser=function(a){var b;return b='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>',a.writeHead(200,{"Content-Length":b.length,"Content-Type":"text/html"}),a.write(b),a.end()},a}(),x.AuthError=function(){function a(a){var b;if(!a.error)throw new Error("Not an OAuth 2.0 error: "+JSON.stringify(a));b="object"==typeof a.error&&a.error.error?a.error:a,this.code=b.error,this.description=b.error_description||null,this.uri=b.error_uri||null}return a.prototype.code=null,a.prototype.description=null,a.prototype.uri=null,a.ACCESS_DENIED="access_denied",a.INVALID_REQUEST="invalid_request",a.UNAUTHORIZED_CLIENT="unauthorized_client",a.INVALID_GRANT="invalid_grant",a.INVALID_SCOPE="invalid_scope",a.UNSUPPORTED_GRANT_TYPE="unsupported_grant_type",a.UNSUPPORTED_RESPONSE_TYPE="unsupported_response_type",a.SERVER_ERROR="server_error",a.TEMPORARILY_UNAVAILABLE="temporarily_unavailable",a.prototype.toString=function(){return"Dropbox OAuth error "+this.code+" :: "+this.description},a.prototype.inspect=function(){return this.toString()},a}(),x.Client=function(){function a(a){var b=this;this._serverRoot=a.server||this._defaultServerRoot(),this._maxApiServer="maxApiServer"in a?a.maxApiServer:this._defaultMaxApiServer(),this._authServer=a.authServer||this._defaultAuthServer(),this._fileServer=a.fileServer||this._defaultFileServer(),this._downloadServer=a.downloadServer||this._defaultDownloadServer(),this._notifyServer=a.notifyServer||this._defaultNotifyServer(),this.onXhr=new x.Util.EventSource({cancelable:!0}),this.onError=new x.Util.EventSource,this.onAuthStepChange=new x.Util.EventSource,this._xhrOnErrorHandler=function(a,c){return b._handleXhrError(a,c)},this._oauth=new x.Util.Oauth(a),this._uid=a.uid||null,this.authStep=this._oauth.step(),this._driver=null,this.authError=null,this._credentials=null,this._datastoreManager=null,this.setupUrls()}return a.prototype.onXhr=null,a.prototype.onError=null,a.prototype.onAuthStepChange=null,a.prototype.authDriver=function(a){return this._driver=a,this},a.prototype.dropboxUid=function(){return this._uid},a.prototype.credentials=function(){return this._credentials||this._computeCredentials(),this._credentials},a.prototype.authenticate=function(a,b){var c,d,e,f,g,h=this;if(b||"function"!=typeof a||(b=a,a=null),c=a&&"interactive"in a?a.interactive:!0,!this._driver&&this.authStep!==k.DONE&&(x.AuthDriver.autoConfigure(this),!this._driver))throw new Error("OAuth driver auto-configuration failed. Call authDriver.");if(this.authStep===k.ERROR)throw new Error("Client got in an error state. Call reset() to reuse it!");return f=function(){return h.authStep=h._oauth.step(),h.authStep===k.ERROR&&(h.authError=h._oauth.error()),h._credentials=null,h.onAuthStepChange.dispatch(h),g()},e=function(){return h.authStep=k.ERROR,h._credentials=null,h.onAuthStepChange.dispatch(h),g()},d=null,g=function(){var a;if(d!==h.authStep&&(d=h.authStep,h._driver&&h._driver.onAuthStepChange))return void h._driver.onAuthStepChange(h,g);switch(h.authStep){case k.RESET:return c?(h._driver.getStateParam&&h._driver.getStateParam(function(a){return h.client.authStep===k.RESET&&h._oauth.setAuthStateParam(a),f()}),h._oauth.setAuthStateParam(x.Util.Oauth.randomAuthStateParam()),f()):void(b&&b(null,h));case k.PARAM_SET:return c?(a=h.authorizeUrl(),h._driver.doAuthorize(a,h._oauth.authStateParam(),h,function(a){return h._oauth.processRedirectParams(a),a.uid&&(h._uid=a.uid),f()})):void(b&&b(null,h));case k.PARAM_LOADED:return h._driver.resumeAuthorize?h._driver.resumeAuthorize(h._oauth.authStateParam(),h,function(a){return h._oauth.processRedirectParams(a),a.uid&&(h._uid=a.uid),f()}):(h._oauth.setAuthStateParam(h._oauth.authStateParam()),void f());case k.AUTHORIZED:return h.getAccessToken(function(a,b){return a?(h.authError=a,e()):(h._oauth.processRedirectParams(b),h._uid=b.uid,f())});case k.DONE:b&&b(null,h);break;case k.SIGNED_OUT:return h.authStep=k.RESET,h.reset(),g();case k.ERROR:b&&b(h.authError,h)}},g(),this},a.prototype.isAuthenticated=function(){return this.authStep===k.DONE},a.prototype.signOut=function(a,b){var c,d,e=this;if(b||"function"!=typeof a||(b=a,a=null),c=a&&a.mustInvalidate,this.authStep!==k.DONE)throw new Error("This client doesn't have a user's token");return d=new x.Util.Xhr("POST",this._urls.signOut),d.signWithOauth(this._oauth),this._dispatchXhr(d,function(a){if(a)if(a.status===x.ApiError.INVALID_TOKEN)a=null;else if(c)return void(b&&b(a));return e.authStep=k.RESET,e.reset(),e.authStep=k.SIGNED_OUT,e.onAuthStepChange.dispatch(e),e._driver&&e._driver.onAuthStepChange?e._driver.onAuthStepChange(e,function(){return b?b(null):void 0}):b?b(null):void 0})},a.prototype.signOff=function(a,b){return this.signOut(a,b)},a.prototype.getAccountInfo=function(a,b){var c,d;return b||"function"!=typeof a||(b=a,a=null),c=!1,a&&a.httpCache&&(c=!0),d=new x.Util.Xhr("GET",this._urls.accountInfo),d.signWithOauth(this._oauth,c),this._dispatchXhr(d,function(a,c){return b(a,x.AccountInfo.parse(c),c)})},a.prototype.getUserInfo=function(a,b){return this.getAccountInfo(a,b)},a.prototype.readFile=function(a,b,c){var d,e,f,g,h,i,j;return c||"function"!=typeof b||(c=b,b=null),e={},i="text",g=null,d=!1,b&&(b.versionTag?e.rev=b.versionTag:b.rev&&(e.rev=b.rev),b.arrayBuffer?i="arraybuffer":b.blob?i="blob":b.buffer?i="buffer":b.binary&&(i="b"),b.length?(null!=b.start?(h=b.start,f=b.start+b.length-1):(h="",f=b.length),g="bytes="+h+"-"+f):null!=b.start&&(g="bytes="+b.start+"-"),b.httpCache&&(d=!0)),j=new x.Util.Xhr("GET",""+this._urls.getFile+"/"+this._urlEncodePath(a)),j.setParams(e).signWithOauth(this._oauth,d),j.setResponseType(i),g&&(g&&j.setHeader("Range",g),j.reportResponseHeaders()),this._dispatchXhr(j,function(a,b,d,e){var f;return f=e?x.Http.RangeInfo.parse(e["content-range"]):null,c(a,b,x.File.Stat.parse(d),f)})},a.prototype.writeFile=function(a,b,c,d){var e;return d||"function"!=typeof c||(d=c,c=null),e=x.Util.Xhr.canSendForms&&"object"==typeof b,e?this._writeFileUsingForm(a,b,c,d):this._writeFileUsingPut(a,b,c,d)},a.prototype._writeFileUsingForm=function(a,b,c,d){var e,f,g,h;return g=a.lastIndexOf("/"),-1===g?(e=a,a=""):(e=a.substring(g),a=a.substring(0,g)),f={file:e},c&&(c.noOverwrite&&(f.overwrite="false"),c.lastVersionTag?f.parent_rev=c.lastVersionTag:(c.parentRev||c.parent_rev)&&(f.parent_rev=c.parentRev||c.parent_rev)),h=new x.Util.Xhr("POST",""+this._urls.postFile+"/"+this._urlEncodePath(a)),h.setParams(f).signWithOauth(this._oauth).setFileField("file",e,b,"application/octet-stream"),delete f.file,this._dispatchXhr(h,function(a,b){return d?d(a,x.File.Stat.parse(b)):void 0})},a.prototype._writeFileUsingPut=function(a,b,c,d){var e,f;return e={},c&&(c.noOverwrite&&(e.overwrite="false"),c.lastVersionTag?e.parent_rev=c.lastVersionTag:(c.parentRev||c.parent_rev)&&(e.parent_rev=c.parentRev||c.parent_rev)),f=new x.Util.Xhr("POST",""+this._urls.putFile+"/"+this._urlEncodePath(a)),f.setBody(b).setParams(e).signWithOauth(this._oauth),this._dispatchXhr(f,function(a,b){return d?d(a,x.File.Stat.parse(b)):void 0})},a.prototype.resumableUploadStep=function(a,b,c){var d,e;return b?(d={offset:b.offset},b.tag&&(d.upload_id=b.tag)):d={offset:0},e=new x.Util.Xhr("POST",this._urls.chunkedUpload),e.setBody(a).setParams(d).signWithOauth(this._oauth),this._dispatchXhr(e,function(a,b){return a&&a.status===x.ApiError.INVALID_PARAM&&a.response&&a.response.upload_id&&a.response.offset?c(null,x.Http.UploadCursor.parse(a.response)):c(a,x.Http.UploadCursor.parse(b))})},a.prototype.resumableUploadFinish=function(a,b,c,d){var e,f;return d||"function"!=typeof c||(d=c,c=null),e={upload_id:b.tag},c&&(c.lastVersionTag?e.parent_rev=c.lastVersionTag:(c.parentRev||c.parent_rev)&&(e.parent_rev=c.parentRev||c.parent_rev),c.noOverwrite&&(e.overwrite="false")),f=new x.Util.Xhr("POST",""+this._urls.commitChunkedUpload+"/"+this._urlEncodePath(a)),f.setParams(e).signWithOauth(this._oauth),this._dispatchXhr(f,function(a,b){return d?d(a,x.File.Stat.parse(b)):void 0})},a.prototype.stat=function(a,b,c){var d,e,f;return c||"function"!=typeof b||(c=b,b=null),e={},d=!1,b&&(b.versionTag?e.rev=b.versionTag:b.rev&&(e.rev=b.rev),b.contentHash?e.hash=b.contentHash:b.hash&&(e.hash=b.hash),(b.removed||b.deleted)&&(e.include_deleted="true"),b.readDir&&(e.list="true",b.readDir!==!0&&(e.file_limit=b.readDir.toString())),b.cacheHash&&(e.hash=b.cacheHash),b.httpCache&&(d=!0)),e.include_deleted||(e.include_deleted="false"),e.list||(e.list="false"),f=new x.Util.Xhr("GET",""+this._urls.metadata+"/"+this._urlEncodePath(a)),f.setParams(e).signWithOauth(this._oauth,d),this._dispatchXhr(f,function(a,b){var d,e,f;return f=x.File.Stat.parse(b),d=(null!=b?b.contents:void 0)?function(){var a,c,d,f;for(d=b.contents,f=[],a=0,c=d.length;c>a;a++)e=d[a],f.push(x.File.Stat.parse(e));return f}():void 0,c(a,f,d)})},a.prototype.readdir=function(a,b,c){var d;return c||"function"!=typeof b||(c=b,b=null),d={readDir:!0},b&&(null!=b.limit&&(d.readDir=b.limit),b.versionTag?d.versionTag=b.versionTag:b.rev&&(d.versionTag=b.rev),b.contentHash?d.contentHash=b.contentHash:b.hash&&(d.contentHash=b.hash),(b.removed||b.deleted)&&(d.removed=b.removed||b.deleted),b.httpCache&&(d.httpCache=b.httpCache)),this.stat(a,d,function(a,b,d){var e,f;return e=d?function(){var a,b,c;for(c=[],a=0,b=d.length;b>a;a++)f=d[a],c.push(f.name);return c}():null,c(a,e,b,d)})},a.prototype.metadata=function(a,b,c){return this.stat(a,b,c)},a.prototype.makeUrl=function(a,b,c){var d,e,f,g,h,i=this;return c||"function"!=typeof b||(c=b,b=null),e=b&&(b["long"]||b.longUrl||b.downloadHack)?{short_url:"false"}:{},a=this._urlEncodePath(a),f=""+this._urls.shares+"/"+a,d=!1,g=!1,b&&(b.downloadHack?(d=!0,g=!0):b.download&&(d=!0,f=""+this._urls.media+"/"+a)),h=new x.Util.Xhr("POST",f).setParams(e).signWithOauth(this._oauth),this._dispatchXhr(h,function(a,b){return g&&(null!=b?b.url:void 0)&&(b.url=b.url.replace(i._authServer,i._downloadServer)),c(a,x.File.ShareUrl.parse(b,d))})},a.prototype.history=function(a,b,c){var d,e,f;return c||"function"!=typeof b||(c=b,b=null),e={},d=!1,b&&(null!=b.limit&&(e.rev_limit=b.limit),b.httpCache&&(d=!0)),f=new x.Util.Xhr("GET",""+this._urls.revisions+"/"+this._urlEncodePath(a)),f.setParams(e).signWithOauth(this._oauth,d),this._dispatchXhr(f,function(a,b){var d,e;return e=b?function(){var a,c,e;for(e=[],a=0,c=b.length;c>a;a++)d=b[a],e.push(x.File.Stat.parse(d));return e}():void 0,c(a,e)})},a.prototype.revisions=function(a,b,c){return this.history(a,b,c)},a.prototype.thumbnailUrl=function(a,b){var c;return c=this.thumbnailXhr(a,b),c.paramsToUrl().url},a.prototype.readThumbnail=function(a,b,c){var d,e;return c||"function"!=typeof b||(c=b,b=null),d="b",b&&(b.blob&&(d="blob"),b.arrayBuffer&&(d="arraybuffer"),b.buffer&&(d="buffer")),e=this.thumbnailXhr(a,b),e.setResponseType(d),this._dispatchXhr(e,function(a,b,d){return c(a,b,x.File.Stat.parse(d))})},a.prototype.thumbnailXhr=function(a,b){var c,d;return c={},b&&(b.format?c.format=b.format:b.png&&(c.format="png"),b.size&&(c.size=b.size)),d=new x.Util.Xhr("GET",""+this._urls.thumbnails+"/"+this._urlEncodePath(a)),d.setParams(c).signWithOauth(this._oauth)},a.prototype.revertFile=function(a,b,c){var d;return d=new x.Util.Xhr("POST",""+this._urls.restore+"/"+this._urlEncodePath(a)),d.setParams({rev:b}).signWithOauth(this._oauth),this._dispatchXhr(d,function(a,b){return c?c(a,x.File.Stat.parse(b)):void 0})},a.prototype.restore=function(a,b,c){return this.revertFile(a,b,c)},a.prototype.findByName=function(a,b,c,d){var e,f,g;return d||"function"!=typeof c||(d=c,c=null),f={query:b},e=!1,c&&(null!=c.limit&&(f.file_limit=c.limit),(c.removed||c.deleted)&&(f.include_deleted=!0),c.httpCache&&(e=!0)),g=new x.Util.Xhr("GET",""+this._urls.search+"/"+this._urlEncodePath(a)),g.setParams(f).signWithOauth(this._oauth,e),this._dispatchXhr(g,function(a,b){var c,e;return e=b?function(){var a,d,e;for(e=[],a=0,d=b.length;d>a;a++)c=b[a],e.push(x.File.Stat.parse(c));return e}():void 0,d(a,e)})},a.prototype.search=function(a,b,c,d){return this.findByName(a,b,c,d)},a.prototype.makeCopyReference=function(a,b){var c;return c=new x.Util.Xhr("GET",""+this._urls.copyRef+"/"+this._urlEncodePath(a)),c.signWithOauth(this._oauth),this._dispatchXhr(c,function(a,c){return b(a,x.File.CopyReference.parse(c))})},a.prototype.copyRef=function(a,b){return this.makeCopyReference(a,b)},a.prototype.pullChanges=function(a,b){var c,d;return b||"function"!=typeof a||(b=a,a=null),c=a?a.cursorTag?{cursor:a.cursorTag}:{cursor:a}:{},d=new x.Util.Xhr("POST",this._urls.delta),d.setParams(c).signWithOauth(this._oauth),this._dispatchXhr(d,function(a,c){return b(a,x.Http.PulledChanges.parse(c))})},a.prototype.delta=function(a,b){return this.pullChanges(a,b)},a.prototype.pollForChanges=function(a,b,c){var d,e;return c||"function"!=typeof b||(c=b,b=null),d=a.cursorTag?{cursor:a.cursorTag}:{cursor:a},b&&"timeout"in b&&(d.timeout=b.timeout),e=new x.Util.Xhr("GET",this._urls.longpollDelta),e.setParams(d),this._dispatchXhr(e,function(a,b){var d;if("string"==typeof b)try{b=JSON.parse(b)}catch(e){d=e,b=null}return c(a,x.Http.PollResult.parse(b))})},a.prototype.mkdir=function(a,b){var c;return c=new x.Util.Xhr("POST",this._urls.fileopsCreateFolder),c.setParams({root:"auto",path:this._normalizePath(a)}).signWithOauth(this._oauth),this._dispatchXhr(c,function(a,c){return b?b(a,x.File.Stat.parse(c)):void 0})},a.prototype.remove=function(a,b){var c;return c=new x.Util.Xhr("POST",this._urls.fileopsDelete),c.setParams({root:"auto",path:this._normalizePath(a)}).signWithOauth(this._oauth),this._dispatchXhr(c,function(a,c){return b?b(a,x.File.Stat.parse(c)):void 0})},a.prototype.unlink=function(a,b){return this.remove(a,b)},a.prototype["delete"]=function(a,b){return this.remove(a,b)},a.prototype.copy=function(a,b,c){var d,e;return d={root:"auto",to_path:this._normalizePath(b)},a instanceof x.File.CopyReference?d.from_copy_ref=a.tag:d.from_path=this._normalizePath(a),e=new x.Util.Xhr("POST",this._urls.fileopsCopy),e.setParams(d).signWithOauth(this._oauth),this._dispatchXhr(e,function(a,b){return c?c(a,x.File.Stat.parse(b)):void 0})},a.prototype.move=function(a,b,c){var d;return d=new x.Util.Xhr("POST",this._urls.fileopsMove),d.setParams({root:"auto",from_path:this._normalizePath(a),to_path:this._normalizePath(b)}).signWithOauth(this._oauth),this._dispatchXhr(d,function(a,b){return c?c(a,x.File.Stat.parse(b)):void 0})},a.prototype.appInfo=function(a,b){var c;return b||"function"!=typeof a||(b=a,a=this._oauth.credentials().key),c=new x.Util.Xhr("GET",this._urls.appsInfo),c.setParams({app_key:a}),this._dispatchXhr(c,function(c,d){return b(c,x.Http.AppInfo.parse(d,a))})},a.prototype.isAppDeveloper=function(a,b,c){var d;return"object"==typeof a&&"uid"in a&&(a=a.uid),c||"function"!=typeof b?"object"==typeof b&&"key"in b&&(b=b.key):(c=b,b=this._oauth.credentials().key),d=new x.Util.Xhr("GET",this._urls.appsCheckDeveloper),d.setParams({app_key:b,uid:a}),this._dispatchXhr(d,function(a,b){return b?c(a,b.is_developer):c(a)})},a.prototype.hasOauthRedirectUri=function(a,b,c){var d;return c||"function"!=typeof b?"object"==typeof b&&"key"in b&&(b=b.key):(c=b,b=this._oauth.credentials().key),d=new x.Util.Xhr("GET",this._urls.appsCheckRedirectUri),d.setParams({app_key:b,redirect_uri:a}),this._dispatchXhr(d,function(a,b){return b?c(a,b.has_redirect_uri):c(a)})},a.prototype.reset=function(){var a;return this._uid=null,this._oauth.reset(),a=this.authStep,this.authStep=this._oauth.step(),a!==this.authStep&&this.onAuthStepChange.dispatch(this),this.authError=null,this._credentials=null,this},a.prototype.setCredentials=function(a){var b;return b=this.authStep,this._oauth.setCredentials(a),this.authStep=this._oauth.step(),this._uid=a.uid||null,this.authError=null,this._credentials=null,b!==this.authStep&&this.onAuthStepChange.dispatch(this),this},a.prototype.appHash=function(){return this._oauth.appHash()},a.prototype.setupUrls=function(){return this._apiServer=this._chooseApiServer(),this._urls={authorize:""+this._authServer+"/1/oauth2/authorize",token:""+this._apiServer+"/1/oauth2/token",signOut:""+this._apiServer+"/1/unlink_access_token",accountInfo:""+this._apiServer+"/1/account/info",getFile:""+this._fileServer+"/1/files/auto",postFile:""+this._fileServer+"/1/files/auto",putFile:""+this._fileServer+"/1/files_put/auto",metadata:""+this._apiServer+"/1/metadata/auto",delta:""+this._apiServer+"/1/delta",longpollDelta:""+this._notifyServer+"/1/longpoll_delta",revisions:""+this._apiServer+"/1/revisions/auto",restore:""+this._apiServer+"/1/restore/auto",search:""+this._apiServer+"/1/search/auto",shares:""+this._apiServer+"/1/shares/auto",media:""+this._apiServer+"/1/media/auto",copyRef:""+this._apiServer+"/1/copy_ref/auto",thumbnails:""+this._fileServer+"/1/thumbnails/auto",chunkedUpload:""+this._fileServer+"/1/chunked_upload",commitChunkedUpload:""+this._fileServer+"/1/commit_chunked_upload/auto",fileopsCopy:""+this._apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this._apiServer+"/1/fileops/create_folder",fileopsDelete:""+this._apiServer+"/1/fileops/delete",fileopsMove:""+this._apiServer+"/1/fileops/move",appsInfo:""+this._apiServer+"/1/apps/info",appsCheckDeveloper:""+this._apiServer+"/1/apps/check_developer",appsCheckRedirectUri:""+this._apiServer+"/1/apps/check_redirect_uri",getDb:""+this._apiServer+"/1/datastores/get_datastore",getOrCreateDb:""+this._apiServer+"/1/datastores/get_or_create_datastore",createDb:""+this._apiServer+"/1/datastores/create_datastore",listDbs:""+this._apiServer+"/1/datastores/list_datastores",deleteDb:""+this._apiServer+"/1/datastores/delete_datastore",getSnapshot:""+this._apiServer+"/1/datastores/get_snapshot",getDeltas:""+this._apiServer+"/1/datastores/get_deltas",putDelta:""+this._apiServer+"/1/datastores/put_delta",datastoreAwait:""+this._apiServer+"/1/datastores/await"},this
},a.prototype._chooseApiServer=function(){var a,b;return b=Math.floor(Math.random()*(this._maxApiServer+1)),a=0===b?"":b.toString(),this._serverRoot.replace("$",a)},a.prototype.authStep=null,a.ERROR=0,a.RESET=1,a.PARAM_SET=2,a.PARAM_LOADED=3,a.AUTHORIZED=4,a.DONE=5,a.SIGNED_OUT=6,a.prototype._urlEncodePath=function(a){return x.Util.Xhr.urlEncodeValue(this._normalizePath(a)).replace(/%2F/gi,"/")},a.prototype._normalizePath=function(a){var b;if("/"===a.substring(0,1)){for(b=1;"/"===a.substring(b,b+1);)b+=1;return a.substring(b)}return a},a.prototype.authorizeUrl=function(){var a;return a=this._oauth.authorizeUrlParams(this._driver.authType(),this._driver.url()),this._urls.authorize+"?"+x.Util.Xhr.urlEncode(a)},a.prototype.getAccessToken=function(a){var b,c;return b=this._oauth.accessTokenParams(this._driver.url()),c=new x.Util.Xhr("POST",this._urls.token).setParams(b).addOauthParams(this._oauth),this._dispatchXhr(c,function(b,c){return b&&b.status===x.ApiError.INVALID_PARAM&&b.response&&b.response.error&&(b=new x.AuthError(b.response)),a(b,c)})},a.prototype._dispatchLongPollXhr=function(a,b,c){return null==c&&(c=6e4),this._dispatchXhr(a,b,c)},a.prototype._dispatchXhr=function(a,b,c){var d,e,f=this;return null==c&&(c=1e4),d=setTimeout(function(){return f._handleLongRequest(a)},2*c),a.setCallback(function(a,c,e,f){return clearTimeout(d),b(a,c,e,f)}),a.onError=this._xhrOnErrorHandler,a.prepare(),e=a.xhr,this.onXhr.dispatch(a)&&a.send(),e},a.prototype._handleXhrError=function(a,b){var c=this;return a.status===x.ApiError.INVALID_TOKEN&&this.authStep===k.DONE&&(this.authError=a,this.authStep=k.ERROR,this.onAuthStepChange.dispatch(this),this._driver&&this._driver.onAuthStepChange)?(this._driver.onAuthStepChange(this,function(){return c.onError.dispatch(a),b(a)}),null):(this.onError.dispatch(a),void b(a))},a.prototype._handleLongRequest=function(){return this.setupUrls()},a.prototype._defaultServerRoot=function(){return"https://api$.dropbox.com"},a.prototype._defaultAuthServer=function(){return this._serverRoot.replace("api$","www")},a.prototype._defaultFileServer=function(){return this._serverRoot.replace("api$","api-content")},a.prototype._defaultDownloadServer=function(){return"https://dl.dropboxusercontent.com"},a.prototype._defaultNotifyServer=function(){return this._serverRoot.replace("api$","api-notify")},a.prototype._defaultMaxApiServer=function(){return 30},a.prototype._computeCredentials=function(){var a;a=this._oauth.credentials(),this._uid&&(a.uid=this._uid),this._serverRoot!==this._defaultServerRoot()&&(a.server=this._serverRoot),this._maxApiServer!==this._defaultMaxApiServer()&&(a.maxApiServer=this._maxApiServer),this._authServer!==this._defaultAuthServer()&&(a.authServer=this._authServer),this._fileServer!==this._defaultFileServer()&&(a.fileServer=this._fileServer),this._downloadServer!==this._defaultDownloadServer()&&(a.downloadServer=this._downloadServer),this._notifyServer!==this._defaultNotifyServer()&&(a.notifyServer=this._notifyServer),this._credentials=a},a}(),k=x.Client,x.Datastore=function(){function a(a,b){var c=this;this._datastore_manager=a,this._managed_datastore=b,this._dsid=this._managed_datastore.get_dsid(),this._handle=this._managed_datastore.get_handle(),this._record_cache=new R(this),this._last_used_timestamp=0,this.recordsChanged=new x.Util.EventSource,this.syncStatusChanged=new x.Util.EventSource,this._timeoutWrapper=function(a){return a},this._evt_mgr=new y,this._evt_mgr.register(this._managed_datastore.syncStateChanged,function(){return c._syncSoon(),c.syncStatusChanged.dispatch(null)}),this._syncPending=!1,this._closed=!1,this._metadata_table=new x.Datastore.Table(this,":info"),this._metadata_table.setResolutionRule("mtime","max")}return a.DATASTORE_SIZE_LIMIT=10485760,a.RECORD_COUNT_LIMIT=1e5,a.BASE_DATASTORE_SIZE=1e3,a.TEAM="team",a.PUBLIC="public",a.OWNER="owner",a.EDITOR="editor",a.VIEWER="viewer",a.NONE="none",a.prototype.recordsChanged=null,a.prototype.syncStatusChanged=null,a.int64=function(a){var b,c;if(Y.is_number(a)&&null!=a[ab.INT64_TAG])return ab.validateInt64(a);if(Y.is_string(a)){if(!ab.is_valid_int64_string(a))throw new Error("Not a valid int64 in string form: "+a);return c=new Number(parseInt(a,10)),c[ab.INT64_TAG]=a,ab.validateInt64(c)}if(!Y.is_number(a)||!isFinite(a))throw new Error("Not a finite number: "+a);if(Number(a)!==Math.round(a))throw new Error("Number is not an integer: "+a);if(b=a.toFixed(),!ab.is_valid_int64_string(b))throw new Error("Number not in int64 range: "+a);return c=new Number(a),c[ab.INT64_TAG]=b,ab.validateInt64(c)},a.isInt64=function(a){return ab.isInt64(a)},a.prototype.getModifiedTime=function(){var a;return a=this._metadata_table.get("info"),null==a?null:a.get("mtime")},a.prototype.getTitle=function(){var a;return a=this._metadata_table.get("info"),null==a?null:a.get("title")},a.prototype.setTitle=function(a){var b;if(null!=a&&!Y.string(a))throw new Error("Title must be a string or null!");return b=this._metadata_table.getOrInsert("info",{}),b.set("title",a)},a.prototype.isShareable=function(){return"."===this._dsid[0]},a.prototype._checkShareable=function(){if(!this.isShareable())throw new Error("Datastore is not shareable")},a.prototype.getEffectiveRole=function(){var a;return this.isShareable()?(a=this._managed_datastore.get_effective_role(),x.Datastore._roleFromInt(a)):x.Datastore.OWNER},a.prototype.isWritable=function(){var a;return a=this.getEffectiveRole(),a===x.Datastore.OWNER||a===x.Datastore.EDITOR},a.prototype._checkWritable=function(){if(!this.isWritable())throw new Error("Datastore is not writable")},a.prototype._checkRole=function(a){if(a!==x.Datastore.EDITOR&&a!==x.Datastore.VIEWER)throw new Error("Invalid role: "+a)},a.prototype._checkPrincipal=function(a){if(a!==x.Datastore.TEAM&&a!==x.Datastore.PUBLIC&&!a.match(/^u[1-9][0-9]*$/))throw new Error("Invalid principal: "+a)},a.prototype._getRole=function(a){var b,c,d;return b=null!=(c=this.getTable(ab.ACL_TID))&&null!=(d=c.get(a))?d.get("role"):void 0,null==b?x.Datastore.NONE:x.Datastore._roleFromInt(b)},a.prototype.getRole=function(a){return this._checkShareable(),this._checkPrincipal(a),this._getRole(a)},a.prototype.setRole=function(a,b){var c;return b===x.Datastore.NONE?void this.deleteRole(a):(this._checkShareable(),this._checkPrincipal(a),this._checkRole(b),this._checkWritable(),c=x.Datastore.int64(x.Datastore._intFromRole(b)),this.getTable(ab.ACL_TID).getOrInsert(a).update({role:c}))},a.prototype.deleteRole=function(a){var b;return this._checkShareable(),this._checkPrincipal(a),this._checkWritable(),null!=(b=this.getTable(ab.ACL_TID).get(a))?b.deleteRecord():void 0},a.prototype.listRoles=function(){var a,b,c,d,e,f;for(this._checkShareable(),c={},f=this.getTable(ab.ACL_TID).query(),d=0,e=f.length;e>d;d++)b=f[d],a=b.getId(),c[a]=this._getRole(a);return c},a._roleFromInt=function(a){switch(!1){case!(a>=ab.ROLE_OWNER):return x.Datastore.OWNER;case!(a>=ab.ROLE_EDITOR):return x.Datastore.EDITOR;case!(a>=ab.ROLE_VIEWER):return x.Datastore.VIEWER;default:return x.Datastore.NONE}},a._intFromRole=function(a){switch(a){case x.Datastore.OWNER:return ab.ROLE_OWNER;case x.Datastore.EDITOR:return ab.ROLE_EDITOR;case x.Datastore.VIEWER:return ab.ROLE_VIEWER;default:return 0}},a.prototype.getTable=function(a){if(this._checkNotClosed(),!x.Datastore.Table.isValidId(a))throw new Error("Invalid table ID: "+a);return new x.Datastore.Table(this,a)},a.prototype.listTableIds=function(){return this._checkNotClosed(),this._managed_datastore.list_tables()},a.prototype.getRecordCount=function(){return this._managed_datastore.get_record_count()},a.prototype.getSize=function(){return this._managed_datastore.get_size()},a.prototype.toString=function(){var a;return a=this._closed?"[closed] ":"","Datastore("+a+this._dsid+" ["+this._handle+"])"},a.prototype.close=function(){return this._closed=!0,this._evt_mgr.unregister_all(),this._listeners=[],void this._datastore_manager._obj_manager.close(this._dsid)},a.prototype.getId=function(){return this._dsid},a.prototype.getSyncStatus=function(){return{uploading:this._managed_datastore.get_outgoing_delta_count()>0}},a.isValidId=function(a){var b;return b=new RegExp(Y.DS_ID_REGEX),Y.is_string(a)&&b.test(a)},a.isValidShareableId=function(a){return this.isValidId(a)&&"."===a[0]},a.prototype._generateRid=function(){var a,b,c,d;for(d="_",b="_js_",c=Math.round(1e3*Date.now()),c<=this._last_used_timestamp&&(c=this._last_used_timestamp+1),this._last_used_timestamp=c,a=c.toString(32);a.length<11;)a="0"+a;return d+a+b+ab.randomWeb64String(5)},a.prototype._syncSoon=function(){var a=this;if(this._managed_datastore.is_deleted())throw new Error("Cannot sync deleted datastore "+this._dsid);return this._checkNotClosed(),void(this._syncPending||(this._syncPending=!0,setTimeout(this._timeoutWrapper(function(){return a._syncPending=!1,a._sync()}),0)))},a.prototype._sync=function(){var a,b,c,d,e,f,g,h,i;this._checkNotClosed(),e=this._managed_datastore.sync(),d=this._resolveAffectedRecordMap(e),a=!1;for(g in d)for(c=d[g],h=0,i=c.length;i>h;h++)b=c[h],_(g===b._tid,"tid mismatch"),a=!0,f=b._rid,this._managed_datastore.query(g,f)||(b._deleted=!0,this._record_cache.remove(g,f));return void(a&&this.recordsChanged.dispatch(new T(d,!1)))},a.prototype._resolveAffectedRecordMap=function(a){var b,c,d,e,f;c={};for(f in a){e=a[f];for(d in e)b=this._record_cache.getOrCreate(f,d),null==c[f]&&(c[f]=[]),c[f].push(b)}return c},a.prototype._recordsChangedLocally=function(a){return void(a.length>0&&(this.recordsChanged.dispatch(T._fromRecordList(a,!0)),this._syncSoon()))},a.prototype._checkNotClosed=function(){if(this._closed||!this._managed_datastore._open)throw new Error("Datastore is already closed: "+this);return void 0},a}(),ab=x.Datastore.impl={},Y=x.Datastore.impl.T={},Y.identity=function(a){return a},Y.get_coerce_fn=function(a){return null!=a.coerce?a.coerce:null!=a.load_json?function(b){return b instanceof a?b:a.load_json(b)}:Y.identity},Y.get_T_fn=function(a){return null!=a.Type?a.Type:a},Y.str=function(a){return Y.is_string(a)?a:Y.is_function(a)?a():JSON.stringify(a)},Y.assert=function(a,b){if(!a)throw new Error(Y.str(b))},_=Y.assert,Y.check=function(a,b,c,d,e,f){if(a)return c;throw Y.fail(b,c,d,e,f),new Error("unreachable")},Y.safe_to_string=function(a){var b,c;try{if(c=a.toString(),"[object Object]"!==c)return c}catch(d){b=d}try{return JSON.stringify(a)}catch(d){b=d}try{if(c=a.constructor.name,null!=c?c.match(/^[A-Za-z0-9_]+$/):void 0)return c}catch(d){b=d}return"[T.safe_to_string failed]"},Y.fail=function(a,b,c,d,e){var f,g;throw g=null!=c?null!=d?null!=e?"Wanted "+Y.str(d)+", but "+Y.str(c)+" in "+Y.str(e)+" "+Y.str(a):"Wanted "+Y.str(d)+", but "+Y.str(c)+" "+Y.str(a):""+Y.str(c)+" "+Y.str(a):null!=d?null!=e?"Wanted "+Y.str(d)+", but in "+Y.str(e)+" "+Y.str(a):"Wanted "+Y.str(d)+", but "+Y.str(a):""+Y.str(a),f=new Error(""+g+": "+Y.safe_to_string(b)),console.error(f),f},Y.any=function(a){return a},Y.defined=function(a,b,c,d){return null==c&&(c="defined"),Y.check("undefined"!=typeof a,"is undefined",a,b,c,d),a},Y.nonnull=function(a,b,c,d){return null==c&&(c="nonnull"),Y.defined(a,b,c,d),Y.check(null!=a,"is null",a,b,c,d),a},Y.member=function(a){var b,c;return c="value in "+JSON.stringify(a),b="not in "+JSON.stringify(a),function(d,e,f,g){return null==f&&(f=c),Y.check(db.call(a,d)>=0,b,d,e,f,g)}},Y.object=function(a,b,c,d){return null==c&&(c="object"),Y.nonnull(a,b,c,d),Y.check("object"==typeof a,"not an object",a,b,c,d),a},Y.bool=function(a,b,c,d){return null==c&&(c="bool"),Y.nonnull(a,b,c,d),Y.check(a===!0||a===!1,"is not bool",a,b,c,d),a},Y.string=function(a,b,c,d){return null==c&&(c="string"),Y.nonnull(a,b,c,d),Y.check(Y.is_string(a),"is not a string",a,b,c,d),a},Y.num=function(a,b,c,d){return null==c&&(c="num"),Y.nonnull(a,b,c,d),Y.check("number"==typeof a,"is not numeric",a,b,c,d),a},Y.int=function(a,b,c,d){return null==c&&(c="int"),Y.num(a,b,c,d),Y.check(0===a%1,"is not an integer",a,b,c,d),a},Y.uint=function(a,b,c,d){return null==c&&(c="uint"),Y.int(a,b,c,d),Y.check(a>=0,"is negative",a,b,c,d),a},Y.nullable=function(a){var b,c;return c="nullable("+a+")",b=function(b,d,e,f){return null==e&&(e=function(){return c}),Y.defined(b,d,e,f),null!=b&&Y.get_T_fn(a)(b,d,e,f),b},b.toString=function(){return c},b.coerce=function(b){return null!=b?Y.get_coerce_fn(a)(b):null},b.fromJSON=function(c){return null!=c?null!=a.fromJSON?a.fromJSON(c):b.coerce(c):null},b},Y.array=function(a,b,c,d){return null==c&&(c="array"),Y.nonnull(a,b,c,d),Y.check(Y.is_array(a),"is not an array",a,b,c,d),a},Y.arrayOf=function(a){var b,c;return c="arrayOf("+a+")",b=function(b,d,e,f){var g,h,i,j,k;for(null==e&&(e=c),Y.array(b,d,e,f),i=j=0,k=b.length;k>j;i=++j)g=b[i],h=function(){return null!=d?"element "+i+" of "+Y.str(d):"element "+i},Y.get_T_fn(a)(g,h,e,f);return b},b.toString=function(){return c},b.coerce=function(b){var d,e,f,g;for(Y.array(b,null,c),g=[],e=0,f=b.length;f>e;e++)d=b[e],g.push(Y.get_coerce_fn(a)(d));return g},b.fromJSON=function(d){var e,f,g,h;if(Y.array(d,"fromJSON input",c),null!=a.fromJSON){for(h=[],f=0,g=d.length;g>f;f++)e=d[f],h.push(a.fromJSON(e));return h}return b.coerce(d)},b},Y.instance=function(a,b,c,d,e){var f;if(!(b instanceof Function))throw new Error("Invalid type given: "+b);return a instanceof b||(null==d&&(d=b.name),Y.check(!1,"got instance of "+(null!=a&&null!=(f=a.constructor)?f.name:void 0),a,c,d,e)),a},Y.unimplemented=function(a){return function(){throw new Error("unimplemented "+a)}},Y.startsWith=function(a,b){return 0===a.lastIndexOf(b,0)},Y.string_matching=function(a){var b;return Y.string(a),Y.check(/^[^].*[$]$/.test(a),"does not start with ^ and end with $",a),b="does not match regex "+a,function(c,d,e,f){return Y.string(c,d,e,f),Y.check(new RegExp(a).test(c),b,c,d,e,f),c}},Y.is_defined=function(a){return"undefined"!=typeof a},Y.is_bool=function(a){return a===!0||a===!1||a&&"object"==typeof a&&a.constructor===Boolean},Y.is_number=function(a){return"number"==typeof a||a&&"object"==typeof a&&a.constructor===Number},Y.is_json_number=function(a){return Y.is_number(a)&&!isNaN(a)&&isFinite(a)},Y.is_string=function(a){return"string"==typeof a||a&&"object"==typeof a&&a.constructor===String},Y.is_function=function(a){return"function"==typeof a},Y.is_object=function(a){return null!=a&&"object"==typeof a},Y.is_array=function(a){return"[object Array]"===Object.prototype.toString.call(a)},Y.is_empty=function(a){return 0===Object.keys(a).length},Y.is_date=function(a){return"[object Date]"===Object.prototype.toString.call(a)},Y.isUint8Array=function(a){return"[object Uint8Array]"===Object.prototype.toString.call(a)},Y.is_simple_map=function(a){var b,c;if(null==a||"object"!=typeof a)return!1;for(b in a)if(c=a[b],!Object.prototype.hasOwnProperty.call(a,b))return!1;return!0},Y.simple_map=function(a,b,c,d){var e,f;null==c&&(c="simple map"),Y.object(a,b,c,d);for(e in a)f=a[e],Y.check(Object.prototype.hasOwnProperty.call(a,e),function(){return"property "+e+" is inherited"},a,b,c,a);return a},Y.simple_typed_map=function(a,b,c){var d,e,f;return d=Y.get_coerce_fn(b),e=Y.get_coerce_fn(c),f=function(d,e,f,g){var h,i;null==f&&(f=a),Y.simple_map(d,e,f,g);for(h in d)i=d[h],Y.get_T_fn(b)(h,"property",null,d),Y.get_T_fn(c)(i,function(){return"value of property "+h},null,d);return d},f.coerce=function(b){var c,f,g;Y.simple_map(b,null,a),f={};for(c in b)g=b[c],f[d(c)]=e(g);return f},f.fromJSON=function(b){var e,f,g;Y.simple_map(b,null,a),f={};for(e in b)g=b[e],f[d(e)]=null!=c.fromJSON?c.fromJSON(g):g;return f},f},Y.DS_ID_REGEX="^[-_a-z0-9]([-_a-z0-9.]{0,62}[-_a-z0-9])?$|^[.][-_a-zA-Z0-9]{1,63}$",Y.dsid=function(a,b,c,d){return null==c&&(c="dsid"),Y.string_matching(Y.DS_ID_REGEX)(a,b,c,d),a},Y.SS_ID_REGEX="^[-._+/=a-zA-Z0-9]{1,64}$|^:[-._+/=a-zA-Z0-9]{1,63}$",Y.tid=function(a,b,c,d){return null==c&&(c="tid"),Y.string_matching(Y.SS_ID_REGEX)(a,b,c,d),a},Y.rowid=function(a,b,c,d){return null==c&&(c="rowid"),Y.string_matching(Y.SS_ID_REGEX)(a,b,c,d),a},Y.field_name=function(a,b,c,d){return null==c&&(c="field name"),Y.string_matching(Y.SS_ID_REGEX)(a,b,c,d),a},function(){var a,b,c;c=[];for(a in Y)b=Y[a],c.push(Y.hasOwnProperty(a)?function(a){return b.toString=function(){return"T."+a}}(a):void 0);return c}(),ab.struct=bb={},bb.define=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(Y.string(a,"struct name"),Y.array(b,"fields"),p=[],o={},g=q=0,r=b.length;r>q;g=++q){e=b[g],Y.array(e,"field","field descriptor",b),Y.check(2<=e.length&&e.length<=3,"does not have length 2 or 3",e,"field descriptor"),l=Y.string(e[0],"field name","field descriptor",b),n=Y.nonnull(e[1],"field type","field descriptor",b),m=e.length<=2?{}:Y.nonnull(e[2],"map of field options","field descriptor",b);for(j in m)"init"!==j&&"initFn"!==j&&Y.fail("unknown option "+j,m,"field options","field descrptor",b);db.call(m,"init")>=0&&db.call(m,"initFn")>=0&&Y.fail("both 'init' and 'initFn' specified",m,"field options","field descriptor",b),i="initFn"in m?m.initFn:"init"in m?(h=m.init,function(a){return function(){return a}}(h)):null,c={name:l,type:n,initFn:i},f="undefined"!=typeof V&&null!==V?new V(c):c,p.push(f),o[l]=f}return k="initializer for "+a+" (fields "+function(){var a,b,c;for(c=[],a=0,b=p.length;b>a;a++)e=p[a],c.push(e.name);return c}().join(", ")+")",d=function(a){var b,c,e;Y.defined(a,"x","initializer");for(l in a)b=a[l],a.hasOwnProperty(l)&&Y.check(null!=o[l],function(){return"has an unexpected field "+l},a,"initializer");for(c=0,e=p.length;e>c;c++)f=p[c],a[f.name]&&!a.hasOwnProperty(f.name)&&Y.fail("Has an indirect property "+f.name,a,"initializer"),a.hasOwnProperty(f.name)?(b=a[f.name],this[f.name]=Y.get_coerce_fn(f.type)(b)):null!=f.initFn?this[f.name]=f.initFn():Y.fail("lacks the field "+f.name,a,"initializer");return d.Type(this,"initializer",k,this),this},d.Type=function(b,c,e,g){var h,i,j;for(Y.defined(b,c,e,g),Y.check(b instanceof d,function(){return"is not an instance of "+a},b,c,e,g),i=0,j=p.length;j>i;i++)f=p[i],Y.check(b.hasOwnProperty(f.name),function(){return"lacks the field "+f.name},b,c,e,g),Y.get_T_fn(f.type)(b[f.name],f.name,e,g);for(l in b)h=b[l],b.hasOwnProperty(l)&&Y.check(null!=o[l],"has an unexpected field",l,c,e,g);return b},d.coerce=function(a){return a instanceof d?(d.Type(a),a):new d(a)},d.prototype.toString=function(){var a,b,c,d,e;for(b=this,a=[],d=0,e=p.length;e>d;d++)f=p[d],c=b[f.name],a.push(""+f.name+": "+(Y.is_object(c)&&Y.is_function(c.toString)?c.toString():JSON.stringify(c)));return"{"+a.join(", ")+"}"},d.prototype.toJSON=function(){var a,b,c,d;for(a=this,b=function(){return""+a},c=0,d=p.length;d>c;c++)f=p[c],Y.get_T_fn(f.type)(this[f.name],f.name,null,b);return this},d.fromJSON=function(a){var b,c;Y.simple_map(a,"input"),b={};for(j in a)c=a[j],f=o[j],null!=f&&(n=f.type,b[j]=null!=n.fromJSON?n.fromJSON(c):c);return new d(b)},d.toString=function(){return"struct "+a},d},V=bb.define("StructField",[["name",Y.string],["type",Y.defined],["initFn",Y.defined]]),bb.toJSO=function(a){var b,c,d,e;if("object"!=typeof a)return a;if(Y.is_array(a))return function(){var c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(bb.toJSO(b));return e}();d={};for(c in a)e=a[c],a.hasOwnProperty(c)&&(d[c]=bb.toJSO(e));return d},bb.union_as_list=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(Y.string(a,"union name"),Y.array(b,"variants"),d=function(){throw new Error("Use "+a+".from_array instead")},j={},i=[],k=function(b,c,e){var f;return f=bb.define(""+a+"."+b,e),f.prototype.tag=function(){return b},f.prototype.toString=function(){return""+a+"."+b+"("+JSON.stringify(this)+")"},f.prototype.toJSON=function(){var a,d,e,f,g,h;for(a=[b],g=0,h=c.length;h>g;g++)d=c[g],e=d[0],f=d[1],Y.get_T_fn(f)(this[e],e),a.push(this[e]);return a},f.from_array=function(d){var e,g,h,i,j,k,l;for(j="initializer for "+a,Y.array(d,"initializer",j),Y.check(d.length===c.length+1,"does not have length "+(c.length+1),d,"initializer",j),Y.check(d[0]===b,"does not have tag "+b,d,"initializer",j),e={_tag:b},h=k=0,l=c.length;l>k;h=++k)g=c[h],i=g[0],e[i]=d[h+1];return new f(e)},f.fromJSON=function(a){return a.length>c.length+1&&(a=a.slice(0,c.length+1)),f.from_array(a)},f.coerce=function(a){return a instanceof f?(f.Type(a),a):f.from_array(a)},j[b]=f,d[b]=f},l=0,m=b.length;m>l;l++)e=b[l],Y.array(e,"variant","variant descriptor",b),Y.check(2===e.length,"does not have length 2",e,"variant descriptor",b),h=Y.string(e[0],"tag","tag",b),f=Y.array(e[1],"fields","variant descriptor",b),g=f.slice(0),g.unshift(["_tag",Y.member([h])]),k(h,f,g),i.push(h);return c="initializer for "+a+" (variants "+i.join(", ")+")",d.from_array=function(b){var c,d;return d="initializer for "+a,Y.array(b,"initializer",d),Y.check(b.length>=1,"lacks a tag",b,"initializer",d),c=b[0],Y.string(c,"tag",d,b),Y.member(i)(c),j[c].from_array(b)},d.fromJSON=function(b){var c,d;return d="initializer for "+a,Y.array(b,"initializer",d),Y.check(b.length>=1,"lacks a tag",b,"initializer",d),c=b[0],Y.string(c,"tag",d,b),Y.member(i)(c),j[c].fromJSON(b)},d.Type=function(b,c,d,e){var f;return null==d&&(d=""+a+".Type"),Y.defined(b,c,d,e),Y.defined(b.tag,"tag",d,e),f=b.tag(),Y.string(f,"tag","initializer",b),Y.member(i)(f),j[f].Type(b,null,"object of type "+a),b},d.coerce=function(a){var b,c;for(c in j)if(b=j[c],a instanceof b)return b.Type(a),a;return d.from_array(a)},d.toString=function(){return"union "+a},d},ab.nonzero_int64_approximate_regex=new RegExp("^-?[1-9][0-9]{0,18}$"),ab.int64_max_str="9223372036854775807",ab.int64_min_str="-9223372036854775808",ab.ACL_TID=":acl",ab.ROLE_OWNER=3e3,ab.ROLE_EDITOR=2e3,ab.ROLE_VIEWER=1e3,ab.int64_string_less_than=function(a,b){var c,d,e;return a===b?!1:(d="0"===a.charAt(0),e="0"===b.charAt(0),d&&!e?!0:e&&!d?!1:(c=a.length===b.length?a>b:a.length>b.length,d&&e?c:!c))},ab.is_valid_int64_string=function(a){return Y.is_string(a)?"0"===a?!0:ab.nonzero_int64_approximate_regex.test(a)?"-"===a.charAt(0)?a.length<ab.int64_min_str.length||a<=ab.int64_min_str:a.length<ab.int64_max_str.length||a<=ab.int64_max_str:!1:!1},ab.is_wrapped_atomic_field_value=function(a){var b,c,d,e;if(!Y.is_simple_map(a))return!1;if(b=Object.keys(a),1!==b.length)return!1;switch(b[0]){case"B":return Y.is_string(a.B);case"N":return"nan"===(d=a.N)||"+inf"===d||"-inf"===d;case"I":case"T":return c=null!=(e=a.I)?e:a.T,ab.is_valid_int64_string(c);default:return!1}},ab.is_atomic_field_value=function(a){return Y.is_bool(a)||Y.is_json_number(a)||Y.is_string(a)||ab.is_wrapped_atomic_field_value(a)},ab.is_list_value=function(a){var b,c,d;if(Y.is_array(a)){for(c=0,d=a.length;d>c;c++)if(b=a[c],!ab.is_atomic_field_value(b))return!1;return!0}return!1},ab.is_compound_field_value=function(a){return ab.is_atomic_field_value(a)||ab.is_list_value(a)},ab.atomic_field_value=function(a,b,c,d){return null==c&&(c="atomic field value"),Y.check(ab.is_atomic_field_value(a),"is not an atomic field value",a,b,c,d),a},ab.list_value=function(a,b,c,d){return null==c&&(c="list value"),Y.arrayOf(ab.atomic_field_value)(a,b,c,d),a},ab.compound_field_value=function(a,b,c,d){return null==c&&(c="field value"),Y.is_array(a)?ab.list_value(a,b,c,d):ab.atomic_field_value(a,b,c,d)},ab.FieldOp=A=bb.union_as_list("FieldOp",[["P",[["value",ab.compound_field_value]]],["D",[]],["LC",[]],["LP",[["at",Y.uint],["value",ab.atomic_field_value]]],["LI",[["before",Y.uint],["value",ab.atomic_field_value]]],["LD",[["at",Y.uint]]],["LM",[["from",Y.uint],["to",Y.uint]]]]),ab.datadict=Y.simple_typed_map("datadict",Y.field_name,ab.compound_field_value),ab.update_datadict=Y.simple_typed_map("update_datadict",Y.field_name,A),ab.Change=d=bb.union_as_list("Change",[["I",[["tid",Y.tid],["rowid",Y.rowid],["fields",ab.datadict]]],["U",[["tid",Y.tid],["rowid",Y.rowid],["updates",ab.update_datadict]]],["D",[["tid",Y.tid],["rowid",Y.rowid]]]]),ab.Delta=w=bb.define("Delta",[["rev",Y.uint],["changes",Y.arrayOf(d)],["nonce",Y.string]]),I=bb.define("ListDatastoresResponseItem",[["dsid",Y.string],["handle",Y.string],["rev",Y.uint],["role",Y.nullable(Y.uint),{init:null}],["info",Y.nullable(ab.datadict),{init:null}]]),ab.ListDatastoresResponse=H=bb.define("ListDatastoresResponse",[["token",Y.string],["datastores",Y.arrayOf(I)]]),G=bb.define("GetSnapshotResponseRow",[["tid",Y.string],["rowid",Y.string],["data",ab.datadict]]),F=bb.define("GetSnapshotResponse",[["rev",Y.uint],["role",Y.nullable(Y.uint),{init:null}],["rows",Y.arrayOf(G)]]),g=bb.define("CreateDatastoreResponse",[["handle",Y.string],["rev",Y.uint],["created",Y.bool],["role",Y.nullable(Y.uint),{init:null}]]),D=bb.define("GetDatastoreResponse",[["handle",Y.nullable(Y.string),{init:null}],["rev",Y.nullable(Y.uint),{init:null}],["role",Y.nullable(Y.uint),{init:null}],["notfound",Y.nullable(Y.string),{init:null}]]),v=bb.define("DeleteDatastoresResponse",[["ok",Y.string]]),P=bb.define("PutDeltaResponse",[["rev",Y.nullable(Y.uint),{init:null}],["role",Y.nullable(Y.uint),{init:null}],["conflict",Y.nullable(Y.string),{init:null}],["notfound",Y.nullable(Y.string),{init:null}],["access_denied",Y.nullable(Y.string),{init:null}]]),E=bb.define("GetDeltasResponse",[["deltas",Y.nullable(Y.arrayOf(w)),{init:null}],["role",Y.nullable(Y.uint),{init:null}],["notfound",Y.nullable(Y.string),{init:null}]]),b=bb.define("AwaitResponseDeltas",[["deltas",Y.simple_typed_map("deltas map",Y.string,E)]]),ab.AwaitResponse=a=bb.define("AwaitResponse",[["get_deltas",Y.nullable(b),{init:null}],["list_datastores",Y.nullable(H),{init:null}]]),c=function(){function a(){this.min_delay_millis=500,this.max_delay_millis=9e4,this.base=1.5,this._failures=0,this.log=!1}return a.prototype.set_log=function(a){this.log=a},a.prototype.set_max_delay_millis=function(a){this.max_delay_millis=a},a.prototype.get_backoff_millis=function(){var a,b;return this._failures+=1,b=Math.min(this.max_delay_millis,this.min_delay_millis*Math.pow(this.base,this._failures-1)),a=(.5+Math.random())*b,this.log&&console.log("get_backoff_millis: failures="+this._failures+", target_delay_millis="+b+", delay_millis="+a),a},a.prototype.reset=function(){return this._failures=0},a}(),U=function(){function a(){this.backoff=new c}var b,d;return d=6e4,b=0,a.prototype.run=function(a,b,c){var e,f,g,h,i,j,k,l=this;return g=null!=(j=b.do_retry)?j:function(){return!0},h=null!=(k=b.giveup_after_ms)?k:d,i=Date.now()+h,f=!1,e=function(){return f?void 0:a(function(){var a,b,d;return a=arguments[0],b=2<=arguments.length?fb.call(arguments,1):[],f?void 0:a&&g(a)?Date.now()>i?(console.error("Giving up due to error",a),c(a)):(d=l.backoff.get_backoff_millis(),console.warn("Retrying in "+d+" ms due to error",a),setTimeout(e,d)):c.apply(null,[a].concat(fb.call(b)))})},e(),function(){return f=!0}},a}(),C=function(){function a(a){this.client=a,this._retry=new U}var b,c;return c=10,b=2419200,a.prototype._run_with_retries=function(a,b,c){var d;return d={giveup_after_ms:1e3*a,do_retry:function(a){var b;return 0===a.status||500<=(b=a.status)&&600>b}},this._retry.run(c,d,b)},a.prototype.delete_db=function(a,b){var d=this;return this._run_with_retries(c,b,function(b){return d.client._deleteDatastore(a,function(a,c){return null!=a?b(a):b(null,c)})})},a.prototype.list_dbs=function(a){var c=this;return this._run_with_retries(b,a,function(a){return c.client._listDatastores(function(b,c){return null!=b?a(b):a(null,c)})})},a.prototype.get_or_create_db=function(a,b){var d=this;return this._run_with_retries(c,b,function(b){return d.client._getOrCreateDatastore(a,function(a,c){return null!=a?b(a):b(null,c)})})},a.prototype.create_db=function(a,b,d){var e=this;return this._run_with_retries(c,d,function(c){return e.client._createDatastore(a,b,function(a,b){return null!=a?c(a):c(null,b)})})},a.prototype.get_db=function(a,b){var d=this;return this._run_with_retries(c,b,function(b){return d.client._getDatastore(a,function(a,c){return null!=a?b(a):b(null,c)})})},a.prototype.await=function(a,c,d){var e,f=this;return e=this._run_with_retries(b,d,function(b){return f.client._datastoreAwait(a,c,function(a,c){return null!=a?b(a):b(null,c)})})},a.prototype.put_delta=function(a,c,d){var e=this;return this._run_with_retries(b,d,function(b){return e.client._putDelta(a,c,function(a,c){return null!=a?b(a):b(null,c)})})},a.prototype.get_snapshot=function(a,b){var d=this;return this._run_with_retries(c,b,function(b){return d.client._getSnapshot(a,function(a,c){return null!=a?b(a):b(null,c)})})},a}(),J=function(){function a(a,b){var c,d,e;for(Y.assert(a.length===b.length,function(){return""+a.length+" changes, "+b.length+" undo_extras"}),this.changes=[],this.undo_extras=[],this._last_simple_mtime_update=null,c=d=0,e=a.length;e>=0?e>d:d>e;c=e>=0?++d:--d)this.add_change(a[c],b[c])}var b;return b=function(a,b){var c,e,f,g,h;switch(g=null,e=null,a.tag()){case"I":g="D";break;case"U":g="U",e={};for(f in b)h=b[f],e[f]=null==h?["D"]:["P",h];break;case"D":g="I",e=ab.clone(b);break;default:throw new Error("Unknown change tag: "+a.tag())}return c=[g,a.tid,a.rowid],null!=e&&c.push(e),d.from_array(c)},a._is_simple_mtime_update=function(a){var b,c;switch(a.tag()){case"I":case"D":return!1;case"U":if(":info"!==a.tid||"info"!==a.rowid)return!1;if(c=Object.keys(a.updates),1!==c.length)return!1;if("mtime"!==c[0])return!1;switch(b=a.updates.mtime,b.tag()){case"P":return!0;case"D":case"LC":case"LP":case"LI":case"LD":case"LM":return!1;default:throw new Error("Unknown field op: "+b.tag())}break;default:throw new Error("Unknown change tag: "+a.tag())}},a._affects_mtime=function(a){if(":info"!==a.tid||"info"!==a.rowid)return!1;switch(a.tag()){case"I":case"D":return!0;case"U":return"mtime"in a.updates?!0:!1;default:throw new Error("Unknown change tag: "+a.tag())}},a.prototype.add_change=function(b,c){return this.changes.push(b),this.undo_extras.push(c),void(a._affects_mtime(b)&&(a._is_simple_mtime_update(b)?(null!=this._last_simple_mtime_update&&(this.changes.splice(this._last_simple_mtime_update,1),this.undo_extras.splice(this._last_simple_mtime_update,1)),this._last_simple_mtime_update=this.changes.length-1):this._last_simple_mtime_update=null))},a.prototype.inverse_changes=function(){var a,c,d,e,f,g;for(d=[],g=this.changes,c=e=0,f=g.length;f>e;c=++e)a=g[c],d.push(b(a,this.undo_extras[c]));return d.reverse(),d},a}(),ab.LocalDelta=J,L=10,M=L,ab.make_nonce=function(){return ab.randomWeb64String(L)},ab.value_size=function(a){var b,c,d,e;if(Y.is_string(a))return x.Util.countUtf8Bytes(a);if(Y.is_bool(a))return 0;if(Y.is_number(a))return 0;if(Y.is_array(a)){for(b=x.Datastore.List.BASE_ITEM_SIZE*a.length,d=0,e=a.length;e>d;d++)c=a[d],b+=ab.value_size(c);return b}if("object"!=typeof a)throw new Error("Unexpected value: "+a);if(null!=a.I)return 0;if(null!=a.N)return 0;if(null!=a.B)return Math.ceil(3*a.B.length/4);if(null!=a.T)return 0;throw new Error("Unexpected object: "+JSON.stringify(a))},ab.size_difference_for_field_op=function(a,b,c){var d,e,f,g;switch(d=a.get(b),c.tag()){case"P":return e=c.value,null==d?x.Datastore.Record.BASE_FIELD_SIZE+ab.value_size(e):ab.value_size(e)-ab.value_size(d);case"D":return null!=d?-(x.Datastore.Record.BASE_FIELD_SIZE+ab.value_size(d)):0;case"LC":return _(null==d,"can't create list for field that already exists"),x.Datastore.Record.BASE_FIELD_SIZE;case"LP":return _(Y.is_array(d),"LP on non-list"),_(0<=(f=c.at)&&f<d.length,"bad index for LP"),ab.value_size(c.value)-ab.value_size(d[c.at]);case"LI":return(null!=d?0:x.Datastore.Record.BASE_FIELD_SIZE)+x.Datastore.List.BASE_ITEM_SIZE+ab.value_size(c.value);case"LD":return _(Y.is_array(d),"LD on non-list"),_(0<=(g=c.at)&&g<d.length,"bad index for LD"),-(x.Datastore.List.BASE_ITEM_SIZE+ab.value_size(d[c.at]));case"LM":return 0;default:throw new Error("unexpected field op type "+c.tag())}},ab.size_difference_for_change=function(a,b){var c,d,e,f,g,h,i;return g=function(){var g,j;switch(b.tag()){case"I":f=x.Datastore.Record.BASE_RECORD_SIZE,g=b.fields;for(c in g)i=g[c],f+=x.Datastore.Record.BASE_FIELD_SIZE+ab.value_size(i);return f;case"U":e=a.get_record(b.tid,b.rowid),Y.assert(null!=e,function(){return"record not found: "+JSON.stringify(b)}),h=0,j=b.updates;for(c in j)d=j[c],h+=ab.size_difference_for_field_op(e,c,d);
return h;case"D":return-a.get_record(b.tid,b.rowid)._size;default:throw new Error("unrecognized tag "+b.tag())}}()},S=function(){function a(a,b,c){var d,e;this._tid=a,this._rid=b,null==c&&(c={}),this._fields={},this._size=x.Datastore.Record.BASE_RECORD_SIZE;for(d in c)e=c[d],this._fields[d]=ab.clone(e),this._size+=x.Datastore.Record.BASE_FIELD_SIZE+ab.value_size(e)}return a.prototype.get=function(a){return this._fields[a]},a.prototype.get_all=function(){return this._fields},a.prototype.put=function(a,b){return void(null!=b?this._fields[a]=ab.clone(b):delete this._fields[a])},a.prototype.apply_field_op=function(a,b){var c,d,e,f,g,h,i;switch(c=this._fields[a],b.tag()){case"P":this._fields[a]=ab.clone(b.value);break;case"D":delete this._fields[a];break;case"LC":_(null==c,"can't create list for field that already exists"),this._fields[a]=[];break;case"LP":_(Y.is_array(c),"LP on non-list"),_(0<=(e=b.at)&&e<c.length,"bad index for LP"),c[b.at]=ab.clone(b.value);break;case"LI":null!=c?(_(Y.is_array(c),"LI on non-list"),_(0<=(f=b.before)&&f<=c.length,"bad index for LI"),c.splice(b.before,0,ab.clone(b.value))):(_(0===b.before,"bad index for LI on nonexistent field"),this._fields[a]=[ab.clone(b.value)]);break;case"LD":_(Y.is_array(c),"LD on non-list"),_(0<=(g=b.at)&&g<c.length,"bad index for LD"),c.splice(b.at,1);break;case"LM":_(Y.is_array(c),"LM on non-list"),_(0<=(h=b.from)&&h<c.length,"bad from index for LM"),_(0<=(i=b.to)&&i<c.length,"bad to index for LM"),d=c[b.from],c.splice(b.from,1),c.splice(b.to,0,d);break;default:throw new Error("unexpected field op type "+b.tag())}return void 0},a.prototype.size=function(){return this._size},a}(),Z=function(){function a(){this._records={}}return a.prototype.get=function(a){return this._records[a]},a.prototype.put=function(a,b){return void(null!=b?this._records[a]=b:delete this._records[a])},a.prototype.has=function(a){return null!=this._records[a]},a.prototype.is_empty=function(){var a;for(a in this._records)return!1;return!0},a.prototype.list_record_ids=function(){var a,b;b=[];for(a in this._records)b.push(a);return b},a}(),j=function(){function a(a,b){var c,d,e,f,g,h;this._tables={},this._record_count=0,this._size=x.Datastore.BASE_DATASTORE_SIZE;for(h in b){e=b[h],g=this._get_table(h);for(f in e)c=e[f],d=new S(h,f,c),this._check_record_size(a,h,f,d._size),g.put(f,d),this._record_count+=1,this._size+=d._size}this._check_datastore_size(a,this._size),this._changedInfoFields={}}return a.from_get_snapshot_resp=function(b){var c,d,e,f,g,h;for(c={},h=b.rows,e=0,f=h.length;f>e;e++)d=h[e],c[g=d.tid]||(c[g]={}),c[d.tid][d.rowid]=d.data;return new a(!1,c)},a.prototype._size_limit_exceeded=function(a,b){var c;if(a)throw c=new Error(b),c.code="SIZE_LIMIT_EXCEEDED",c;return void console.warn(b)},a.prototype._check_record_size=function(a,b,c,d){return void(d>x.Datastore.Record.RECORD_SIZE_LIMIT&&this._size_limit_exceeded(a,"Record ("+b+", "+c+") too large: "+d+" bytes"))},a.prototype._check_datastore_size=function(a,b){return void(b>x.Datastore.DATASTORE_SIZE_LIMIT&&this._size_limit_exceeded(a,"Datastore too large: "+b+" bytes"))},a.prototype._TEST_calculate_size_from_scratch=function(){var a,b,c,d,e,f,g,h,i,j,k,l;d=0,j=this._tables;for(f in j)for(e=j[f],k=e.list_record_ids(),h=0,i=k.length;i>h;h++){c=k[h],b=e.get(c),d+=x.Datastore.Record.BASE_RECORD_SIZE,l=b.get_all();for(a in l)g=l[a],d+=x.Datastore.Record.BASE_FIELD_SIZE+ab.value_size(g)}return d},a.prototype.raw_data=function(){var a,b,c,d,e,f,g,h;a={},g=this._tables;for(d in g)for(c=g[d],a[d]={},h=c.list_record_ids(),e=0,f=h.length;f>e;e++)b=h[e],a[d][b]=ab.clone(c.get(b).get_all());return a},a.prototype.get_record=function(a,b){var c;return null!=(c=this._tables[a])?c.get(b):void 0},a.prototype.clearInfoFields=function(){return this._changedInfoFields={}},a.prototype.updateInfoFieldsFromChange=function(a){var b,c,d,e,f,g,h,i,j;switch(Y.assert(":info"===a.tid,function(){return"updateInfoField: table must be :info, got "+a.tid}),Y.assert("info"===a.rowid,function(){return"updateInfoField: row must be info, got "+a.rowid}),a.tag()){case"I":f=a.fields,h=[];for(b in f)d=f[b],h.push(this._changedInfoFields[b]=!0);return h;case"U":g=a.updates,i=[];for(b in g)e=g[b],i.push(this._changedInfoFields[b]=!0);return i;case"D":if(c=this.get_record(":info","info"),null!=c){j=[];for(b in c.get_all())j.push(this._changedInfoFields[b]=!0);return j}break;default:throw new Error("Unknown change tag: "+a.tag())}},a.prototype.updateDatastoreInfo=function(a){var b,c;a=ab.clone(a||{}),b=this.query(":info","info")||{};for(c in this._changedInfoFields)c in b?a[c]=b[c]:delete a[c];return a},a.prototype.getLocalInfoData=function(){return ab.clone(this.query(":info","info")||{})},a.prototype.apply_change=function(a,b){var c,d,e;switch(c=ab.size_difference_for_change(this,b),c>=0&&this._check_datastore_size(a,this._size+c),":info"===b.tid&&"info"===b.rowid&&this.updateInfoFieldsFromChange(b),b.tag()){case"I":this._check_record_size(a,b.tid,b.rowid,c),this._record_count+=1,e=this._apply_insert(b);break;case"U":d=this.get_record(b.tid,b.rowid),Y.assert(null!=d,function(){return"apply_change: record does not exist: "+JSON.stringify(b)}),c>=0&&this._check_record_size(a,b.tid,b.rowid,d._size+c),e=this._apply_update(d,b),d._size+=c;break;case"D":this._record_count-=1,e=this._apply_delete(b);break;default:throw new Error("unrecognized tag "+b.tag())}return this._size+=c,e},a.prototype._get_table=function(a){return null==this._tables[a]&&(this._tables[a]=new Z),this._tables[a]},a.prototype._apply_insert=function(a){var b,c;return c=this._get_table(a.tid),Y.assert(!c.has(a.rowid),function(){return"_apply_insert: record already exists: "+JSON.stringify(a)}),b=new S(a.tid,a.rowid,a.fields),c.put(a.rowid,b),null},a.prototype._apply_update=function(a,b){var c,d,e,f,g,h,i;f={};try{h=b.updates;for(d in h)e=h[d],g=ab.clone(null!=(i=a.get(d))?i:null),a.apply_field_op(d,e),f[d]=g}catch(j){c=j;for(d in f)g=f[d],a.put(!1,d,g);throw c}return f},a.prototype._apply_delete=function(a){var b,c,d;return d=this._get_table(a.tid),Y.assert(d.has(a.rowid),function(){return"_apply_delete: record does not exist: "+JSON.stringify(a)}),c=d.get(a.rowid),b=ab.clone(c.get_all()),d.put(a.rowid,null),d.is_empty()&&delete this._tables[a.tid],b},a.prototype.query=function(a,b){var c,d;return d=this._tables[a],null==d?null:(c=d.get(b),null==c?null:ab.clone(c.get_all()))},a.prototype.list_tables=function(){var a,b;return a=function(){var a;a=[];for(b in this._tables)a.push(b);return a}.call(this),a.sort(),a},a.prototype.list_rows_for_table=function(a){var b,c;return c=this._tables[a],null==c?[]:(b=c.list_record_ids(),b.sort(),b)},a.prototype.record_count=function(){return this._record_count},a.prototype.size=function(){return this._size},a}(),K=function(){function a(a,b,c,d,e,f,g,h){this.dbid=a,this.handle=b,this.role=c,this.datastore_model=d,this.resolver=e,this.sync_state=f,this.flob_client=g,this._dslist_listener=h,this.syncStateChanged=new x.Util.EventSource,this._deleted=!1,this._open=!0,this._put_delta_queue=new W,this._update_mtime_on_change=!0}return a.fresh_managed_datastore=function(b,c,d,e,f,g,h,i){var j;return j=new X(f),new a(b,c,d,e,g,j,h,i)},a.prototype.get_dsid=function(){return this.dbid},a.prototype.get_handle=function(){return this.handle},a.prototype.get_effective_role=function(){return this.role},a.prototype.is_deleted=function(){return this._deleted},a.prototype.mark_deleted=function(){return this._deleted=!0},a.prototype.open=function(){if(this._open)throw new Error("Attempt to open datastore multiple times");return this._open=!0},a.prototype.close=function(){if(!this._open)throw new Error("Attempt to close datastore multiple times");return this._open=!1},a.prototype.is_closed=function(){return!this._open},a.prototype._updateInfoFieldsAfterSync=function(){var a,b,c,d,e,f;for(this.datastore_model.clearInfoFields(),e=this.sync_state.unsynced_deltas,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(function(){var c,d,e,f;for(e=b.changes,f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(":info"===a.tid&&"info"===a.rowid?this.datastore_model.updateInfoFieldsFromChange(a):void 0);return f}.call(this));return f},a.prototype._should_notify_dslist_listener_for=function(a){var b,c;if(b=function(a){var b;for(b in a)if("mtime"!==b)return!0;return!1},":info"!==a.tid||"info"!==a.rowid)return!1;switch(a.tag()){case"D":if(c=this.datastore_model.get_record(a.tid,a.rowid),null==c)throw new Error("Record not found: "+a.tid+" "+a.rowid);return b(c.get_all());case"U":return b(a.updates);case"I":return b(a.fields);default:throw new Error("unknown change tag: "+a.tag())}},a.prototype._rollback_unsynced_deltas=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(b={},g=this.sync_state.unsynced_deltas.slice().reverse(),h=0,k=g.length;k>h;h++){for(f=g[h],e=f.inverse_changes(),i=0,l=e.length;l>i;i++)d=e[i],this.datastore_model.apply_change(!1,d);if(a)for(j=0,m=e.length;m>j;j++)c=e[j],c.tid in b||(b[c.tid]={}),b[c.tid][c.rowid]=!0}return b},a.prototype._do_sync=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(f=this.sync_state.get_server_deltas(),0===f.length)return{};for(e=this.resolver.resolve(this.sync_state.unsynced_deltas,f),d=e.rebased_deltas,a=e.affected_records,g=!1,this._rollback_unsynced_deltas(!1),i=0,m=f.length;m>i;i++)for(c=f[i],q=c.changes,j=0,n=q.length;n>j;j++)b=q[j],g|=this._should_notify_dslist_listener_for(b),this.datastore_model.apply_change(!1,b);for(k=0,o=d.length;o>k;k++)for(c=d[k],c.undo_extras=[],r=c.changes,l=0,p=r.length;p>l;l++)b=r[l],g|=this._should_notify_dslist_listener_for(b),h=this.datastore_model.apply_change(!1,b),c.undo_extras.push(h);return this.sync_state.update_unsynced_deltas(d),g&&this._dslist_listener(),a},a.prototype._do_put_delta=function(){var a,b=this;return this.sync_state.delta_pending()||(a=this.sync_state.get_delta_to_put(),null==a)?void 0:this._put_delta_queue.request(function(){return b.flob_client.put_delta(b.handle,a,function(c,d){return null==c&&(null!=d.rev&&(b.sync_state.put_succeeded(a),b.syncStateChanged.dispatch(null)),null!=d.access_denied&&(console.log("Write access denied, reverting pending changes. Reason:",d.access_denied),b._affected_records_from_access_denied=b._rollback_unsynced_deltas(!0),b.sync_state.clear_unsynced_deltas(),b.role=ab.ROLE_VIEWER,b.syncStateChanged.dispatch(null))),b._put_delta_queue.finish()})})},a.prototype._apply_and_queue_local_change=function(a,b){var c,d;return c=this._should_notify_dslist_listener_for(b),d=this.datastore_model.apply_change(a,b),this.sync_state.add_unsynced_change(b,d),void(c&&this._dslist_listener())},a.prototype._clock=function(){return new Date},a.prototype._update_mtime=function(){var a;return this._update_mtime_on_change?(a=d.from_array(null!=this.datastore_model.query(":info","info")?["U",":info","info",{mtime:["P",ab.toDsValue(this._clock())]}]:["I",":info","info",{mtime:ab.toDsValue(this._clock())}]),this._apply_and_queue_local_change(!1,a)):null},a.prototype.perform_local_change=function(a){return this._apply_and_queue_local_change(!0,a),this._update_mtime(),this.syncStateChanged.dispatch(null)},a.prototype.sync=function(){var a;return a=this._affected_records_from_access_denied,null!=a?(delete this._affected_records_from_access_denied,a):(this.has_unfinalized_changes()&&this.sync_state.finalize(),a=this._do_sync(),this._do_put_delta(),this._updateInfoFieldsAfterSync(),a)},a.prototype.get_outgoing_delta_count=function(){return this.sync_state.unsynced_deltas.length},a.prototype.get_incoming_delta_count=function(){return this.sync_state.get_server_deltas().length},a.prototype.has_unfinalized_changes=function(){return this.sync_state.has_unfinalized_changes()},a.prototype.receive_server_delta=function(a){return this.sync_state.receive_server_delta(a),void this.syncStateChanged.dispatch(null)},a.prototype.query=function(a,b){return this.datastore_model.query(a,b)},a.prototype.list_tables=function(){var a;return function(){var b,c,d,e;for(d=this.datastore_model.list_tables(),e=[],b=0,c=d.length;c>b;b++)a=d[b],":info"!==a&&a!==ab.ACL_TID&&e.push(a);return e}.call(this)},a.prototype.list_rows_for_table=function(a){return this.datastore_model.list_rows_for_table(a)},a.prototype.get_record_count=function(){return this.datastore_model.record_count()},a.prototype.get_record_size=function(a,b){return this.datastore_model.get_record(a,b).size()},a.prototype.get_size=function(){return this.datastore_model.size()},a}(),X=function(){function a(a){this._server_rev=a,Y.uint(this._server_rev,"_server_rev"),this._pending_delta=null,this._server_deltas=[],this.unsynced_deltas=[],this._last_unsynced_delta_unfinalized=!1}return a.prototype.get_server_rev=function(){return this._server_rev},a.prototype.is_current=function(){return 0===this.unsynced_deltas.length&&0===this._server_deltas.length},a.prototype.get_server_deltas=function(){return this._server_deltas},a.prototype.add_unsynced_change=function(a,b){var c;return c=this.unsynced_deltas.length,void(this._last_unsynced_delta_unfinalized?this.unsynced_deltas[c-1].add_change(a,b):(this.unsynced_deltas.push(new J([a],[b])),this._last_unsynced_delta_unfinalized=!0))},a.prototype._compact_deltas=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(_(null==this._pending_delta,"delta pending"),d=this.unsynced_deltas.length,!(1>=d)){for(g=this._last_unsynced_delta_unfinalized?this.unsynced_deltas.pop():null,b=[],f=[],n=this.unsynced_deltas,h=0,k=n.length;k>h;h++){for(c=n[h],o=c.changes,i=0,l=o.length;l>i;i++)a=o[i],b.push(a);for(p=c.undo_extras,j=0,m=p.length;m>j;j++)e=p[j],f.push(e)}return this.unsynced_deltas=[new J(b,f)],void(null!=g&&this.unsynced_deltas.push(g))}},a.prototype.get_delta_to_put=function(){var a,b;return _(null==this._pending_delta,"delta pending"),a=this.unsynced_deltas.length,0===a||1===a&&this._last_unsynced_delta_unfinalized?null:(this._compact_deltas(),this._last_unsynced_delta_unfinalized&&_(this.unsynced_deltas.length>1,"the only delta is unfinalized"),b=this.unsynced_deltas[0],this._pending_delta=new w({changes:b.changes.slice(),nonce:ab.make_nonce(),rev:this._server_rev}),this._pending_delta)},a.prototype.delta_pending=function(){return null!=this._pending_delta},a.prototype.has_unfinalized_changes=function(){return this._last_unsynced_delta_unfinalized},a.prototype.finalize=function(){return void(this._last_unsynced_delta_unfinalized=!1)},a.prototype.update_unsynced_deltas=function(a){return this.unsynced_deltas=a,this._server_rev+=this._server_deltas.length,this._server_deltas=[]},a.prototype._is_our_pending=function(a){return null!=this._pending_delta&&this._pending_delta.nonce===a.nonce},a.prototype._ack=function(a){return _(this._is_our_pending(a),"not ours"),_(0===this._server_deltas.length,"server deltas exist"),this._pending_delta=null,this.unsynced_deltas.shift(),this._server_rev++},a.prototype.put_succeeded=function(a){return this._is_our_pending(a)?this._ack(a):void 0},a.prototype.clear_unsynced_deltas=function(){return this._pending_delta=null,this.unsynced_deltas=[],this._last_unsynced_delta_unfinalized=!1},a.prototype.receive_server_delta=function(a){var b,c;return c=this._server_deltas.length,b=c>0?this._server_deltas[c-1].rev+1:this._server_rev,_(a.rev<=b,"was expecting rev "+b+", but got "+a.rev+" instead!"),a.rev<b?void 0:void(this._is_our_pending(a)?this._ack(a):(this._server_deltas.push(a),this._pending_delta=null))},a}(),ab.DatastoreModel=j,O=function(){function a(a){this.update_manager=a,this.cancelled=!1,this.cancel_fn=null}return a.prototype.cancel=function(){return null!=this.cancel_fn&&this.cancel_fn(),this.cancelled=!0},a.prototype.poll=function(){var a,b=this;return(a=function(){var c;return b.cancelled?void 0:(c=ab.clone(b.update_manager._handle_version_map),b.cancel_fn=b.update_manager.flob_client.await(c,b.update_manager._last_dslist_token,function(d,e){var f,g,h,i,j,k,l,m,n,o;if(b.cancel_fn=null,d)return 0===d.status?(console.log("await deltas failed (offline):",d),setTimeout(a,1e4)):d.status&&500<=(m=d.status)&&599>=m?(console.log("server error:",d),setTimeout(a,2e3)):(console.error("Got error in longpoll:",d),setTimeout(a,1e4));if(null!=e.get_deltas){n=e.get_deltas.deltas;for(i in n)if(g=n[i],null!=g.notfound)b.update_manager._data_queue.push({handle:i,notfound:g.notfound}),delete b.update_manager._handle_version_map[i];else if(null!=g.deltas){for(null!=g.role&&b.update_manager._data_queue.push({handle:i,role:g.role}),o=g.deltas,k=0,l=o.length;l>k;k++)h=o[k],b.update_manager._data_queue.push({handle:i,delta:h});j=c[i]+g.deltas.length,f=b.update_manager._handle_version_map[i],null!=f&&(b.update_manager._handle_version_map[i]=Math.max(f,j))}}return null!=e.list_datastores&&(b.update_manager._last_dslist_token=e.list_datastores.token,b.update_manager._data_queue.push({dslist:e.list_datastores})),setTimeout(a,0)}))})()},a}(),z=function(){function a(a){this.flob_client=a,this._data_queue=null,this._handle_version_map={},this._last_dslist_token=".",this._pending_poll=null,this._running=!1}return a.prototype.run=function(a){return this._data_queue=new f(a),this._running=!0,this._do_longpoll()},a.prototype.stop=function(){return this._pending_poll?this._pending_poll.cancel():void 0},a.prototype.add_poll=function(a,b){var c,d;return _(this._running,"update manager is not running"),c=this._handle_version_map[a],d=b,null!=c&&(d=Math.max(b,c)),this._handle_version_map[a]=d,this._do_longpoll()},a.prototype.remove_poll=function(a){return _(this._running,"update manager is not running"),a in this._handle_version_map?(delete this._handle_version_map[a],this._do_longpoll()):void 0},a.prototype._do_longpoll=function(){return _(this._running,"update manager is not running"),this._pending_poll&&(this._pending_poll.cancel(),this._pending_poll=null),this._pending_poll=new O(this),this._pending_poll.poll()},a}(),N=function(){function a(a,b,c,d){this.update_manager=a,this.flob_client=b,this._dslist_listener_server=c,this._dslist_listener_local=d,this.update_manager.run(this._handle_server_update.bind(this)),this._cached_objects={},this._handle_to_dsid_map={}}return a.prototype.destroy=function(){var a;for(a in this._cached_objects)this._cached_objects[a].close();return this.update_manager.stop()},a.prototype.getAllCachedUndeletedDatastoreIDs=function(){var a,b;return function(){var c,d;c=this._cached_objects,d=[];for(b in c)a=c[b],a.is_deleted()||d.push(b);return d}.call(this)},a.prototype.getCachedDatastore=function(a){return this._cached_objects[a]},a.prototype._evict=function(a){var b,c;return b=this._handle_to_dsid_map[a],null!=b?(delete this._handle_to_dsid_map[a],b in this._cached_objects&&(c=this._cached_objects[b],c.mark_deleted(),c.is_closed()&&delete this._cached_objects[b]),this.update_manager.remove_poll(a)):void 0},a.prototype.close=function(a){var b,c;if(!(a in this._cached_objects))throw new Error("Attempt to close unknown datastore: "+a);return b=this._cached_objects[a].get_handle(),c=this._cached_objects[a],c.close(),c.is_deleted()?delete this._cached_objects[a]:void 0},a.prototype._handle_server_update=function(a,b){var c,d,e;return a.dslist?(this._dslist_listener_server&&this._dslist_listener_server(a.dslist),b(null)):(e=a.handle,c=this._handle_to_dsid_map[e],null==c?(console.log("unknown handle "+e+" (maybe datastore was evicted)",a,this._handle_to_dsid_map,this._cached_objects),b(null)):null==a.delta?(null!=a.notfound?this._evict(e):null!=a.role&&null!=this._cached_objects[c]&&(this._cached_objects[c].role=a.role),b(null)):(d=a.delta,this._retrieve(c,e,function(a,c){return a?b(a):(c.receive_server_delta(d),b(null))})))},a.prototype.open=function(a,b,c){return this._cached_objects[a]&&this._cached_objects[a].open(),this._retrieve(a,b,c)},a.prototype._retrieve=function(a,b,c){var d,e=this;return d=this._cached_objects[a],null!=d?c(null,d):(this._handle_to_dsid_map[b]=a,this.flob_client.get_snapshot(b,function(d,f){var g,h,i;return null!=d?c(d):null!=e._cached_objects[a]?c(null,e._cached_objects[a]):(g=j.from_get_snapshot_resp(f),i=new u,h=K.fresh_managed_datastore(a,b,f.role,g,f.rev,i,e.flob_client,e._dslist_listener_local),e.update_manager.add_poll(b,h.sync_state.get_server_rev()),e._cached_objects[a]=h,c(null,h))}))},a}(),B=function(){function a(a){var e,f,g,h,j,k,l,m,n,r,s,t=this;for(this.rule_name=null!=a?a:"default",this.precedence=d[this.rule_name],this._transforms={},g=0,k=c.length;k>g;g++)f=c[g],this._transforms[f]={};for(s=["P","D"],h=0,l=s.length;l>h;h++)for(f=s[h],j=0,m=b.length;m>j;j++)e=b[j],this._transforms[f][e]=o,this._transforms[e][f]=p;for(r=0,n=b.length;n>r;r++)e=b[r],"LC"===e?this._transforms.LC.LC=function(){return[null,null]}:(this._transforms.LC[e]=p,this._transforms[e].LC=o);this._transforms.P.P=function(a,b){var c;return c=t.precedence(a.value,b.value),"left"===c?[a,null]:[null,b]},this._transforms.P.D=function(a,b){var c;return c=t.precedence(a.value,null),"left"===c?[a,null]:[null,b]},this._transforms.D.P=function(a,b){var c;return c=t.precedence(null,b.value),"left"===c?[a,null]:[null,b]},this._transforms.D.D=function(a,b){var c;return c=t.precedence(null,null),"left"===c?[a,null]:[null,b]},this._transforms.LP.LP=function(a,b){var c;return a.at!==b.at?[a,b]:(c=t.precedence(a.value,b.value),"left"===c?[a,null]:[null,b])},this._transforms.LP.LI=function(a,b){var c;return c=i(a),c.at+=b.before<=a.at?1:0,[c,b]},this._transforms.LP.LD=function(a,b){var c;return a.at===b.at?[null,b]:(c=i(a),c.at-=b.at<a.at?1:0,[c,b])},this._transforms.LP.LM=function(a,b){var c;return c=i(a),a.at===b.from?c.at=b.to:(c.at-=b.from<c.at?1:0,c.at+=b.to<=c.at?1:0),[c,b]},this._transforms.LI.LP=q(this._transforms.LP.LI),this._transforms.LI.LI=function(a,b){var c,d,e;return e=[i(a),i(b)],c=e[0],d=e[1],a.before<b.before?d.before+=1:c.before+=1,[c,d]},this._transforms.LI.LD=function(a,b){var c,d,e;return e=[i(a),i(b)],c=e[0],d=e[1],c.before-=b.at<a.before?1:0,d.at+=a.before<=b.at?1:0,[c,d]},this._transforms.LI.LM=function(a,b){var c,d,e,f;return f=[i(a),i(b)],d=f[0],e=f[1],a.before===b.to+1&&b.from<=b.to?[a,b]:a.before===b.to&&b.from>b.to?(d.before++,e.from++,[d,e]):(c=b.from<a.before?a.before-1:a.before,e.from+=a.before<=b.from?1:0,d.before=b.to<c?c+1:c,e.to+=c<=b.to?1:0,[d,e])},this._transforms.LD.LP=q(this._transforms.LP.LD),this._transforms.LD.LI=q(this._transforms.LI.LD),this._transforms.LD.LD=function(a,b){var c,d,e;return a.at===b.at?[null,null]:(e=[i(a),i(b)],c=e[0],d=e[1],a.at<b.at?d.at-=1:c.at-=1,[c,d])},this._transforms.LD.LM=function(a,b){var c,d,e;return a.at===b.from?(c=i(a),c.at=b.to,[c,null]):(e=[i(a),i(b)],c=e[0],d=e[1],c.at-=b.from<c.at?1:0,c.at+=b.to<=c.at?1:0,d.to+=d.from<d.to?1:0,d.from-=a.at<d.from?1:0,d.to-=a.at<d.to?1:0,d.to-=d.from<d.to?1:0,[c,d])},this._transforms.LM.LP=q(this._transforms.LP.LM),this._transforms.LM.LI=function(a,b){var c,d,e,f;return f=[i(a),i(b)],d=f[0],e=f[1],b.before===a.to+1&&a.from<=a.to?[a,b]:b.before===a.to&&a.from>a.to?(d.from++,d.to++,[d,e]):(c=a.from<b.before?b.before-1:b.before,d.from+=b.before<=a.from?1:0,e.before=a.to<c?c+1:c,d.to+=c<=a.to?1:0,[d,e])},this._transforms.LM.LD=q(this._transforms.LD.LM),this._transforms.LM.LM=function(a,b){var c,d,e,f,g,h,j,k,l,m,n;return a.from===b.from?a.to===b.to?[null,null]:b.from===b.to?[a,b]:(f=i(b),f.from=a.to,[null,f]):a.to===a.from?(e=i(a),e.from+=(b.to<=a.from)-(b.from<a.from),a.from===b.to&&b.from<b.to&&e.from--,e.to=e.from,[e,b]):b.to===b.from?(f=i(b),f.from+=(a.to<=b.from)-(a.from<b.from),f.to=f.from,[a,f]):(j=[i(a),i(b)],e=j[0],f=j[1],a.to===b.to&&a.from>a.to&&b.from>b.to?(e.to++,b.from>a.from?e.from++:f.from++,[e,f]):a.from===b.to&&b.from===a.to&&a.from<a.to?(f.from--,e.from++,[e,f]):a.from>a.to&&b.from<b.to&&b.to+1===a.to?[a,b]:(k=[a.to,a.from],g=k[0],c=k[1],g+=a.from<g?1:0,g-=b.from<g?1:0,g+=b.to<g?1:0,c-=b.from<c?1:0,c+=b.to<=c?1:0,g-=g>c?1:0,l=[b.to,b.from],h=l[0],d=l[1],h+=b.from<h?1:0,h-=a.from<h?1:0,h+=a.to<=h?1:0,d-=a.from<d?1:0,d+=a.to<=d?1:0,h-=h>d?1:0,m=[g,c],e.to=m[0],e.from=m[1],n=[h,d],f.to=n[0],f.from=n[1],[e,f]))}}var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(q=function(a){return _(null!=a),function(b,c){var d,e,f;return f=a(c,b),d=f[0],e=f[1],[e,d]}},e=["null","bool","num","str","blob","ts","list"],f={},k=s=0,t=e.length;t>s;k=++s)r=e[k],f[r]=k;return j=function(a){if(null==a)return"null";if(Y.is_bool(a))return"bool";if(null!=a.I||Y.is_number(a))return"num";if(Y.is_string(a))return"str";if(null!=a.B)return"blob";if(null!=a.T)return"ts";if(Y.is_array(a))return"list";throw new Error("Unrecognized value "+a)},n=function(a){return Y.is_number(a)||null!=a.I},g=function(a){return null!=a.I?parseInt(a.I):a},m=function(a,b){var c,d,e;for(c=d=0,e=a.length;e>=0?e>d:d>e;c=e>=0?++d:--d){if(c>=b.length)return!1;if(l(a[c],b[c]))return!0;if(l(b[c],a[c]))return!1}return b.length>a.length},a._is_less_than=l=function(a,b){var c,d;if(c=j(a),d=j(b),c!==d)return f[c]<f[d];if("null"===c)return!1;if("bool"===c)return b&&!a;if("num"===c)return null!=a.I&&null!=b.I?ab.int64_string_less_than(a.I,b.I):g(a)<g(b);if("str"===c)return b>a;if("blob"===c)return a.B<b.B;if("ts"===c)return parseInt(a.T,10)<parseInt(b.T,10);if("list"===c)return m(a,b);throw new Error("unknown type "+c)},a._compute_sum=h=function(a,b,c){var d,e,f,g,h,i;return d=null!=a.I&&null!=b.I&&null!=c.I,null!=a.I&&(a=parseInt(a.I)),null!=b.I&&(b=parseInt(b.I)),null!=c.I&&(c=parseInt(c.I)),g=0x8000000000000000,h=0x10000000000000000,i=0xfffffffffffff800,e=b-a,f=c+e,d&&(f>=g&&(f-=i),-g>f&&(f+=i),f={I:""+f}),f},p=function(a,b){return[null,b]},o=function(a){return[a,null]},c=["P","D","LC","LP","LI","LD","LM"],b=["LC","LP","LI","LD","LM"],a.copy=i=function(a){return A.from_array(JSON.parse(JSON.stringify(a)))},d={"default":function(){return"right"},remote:function(){return"right"},local:function(){return"left"},min:function(a,b){return l(a,b)?"left":"right"},max:function(a,b){return l(a,b)?"right":"left"},sum:function(){return"right"}},a.prototype.transform=function(a,b,c){var d,e,f,g,i;return null==c&&(c=null),"sum"===this.rule_name&&"P"===a.tag()&&"P"===b.tag()&&(null==c&&(c={I:"0"}),n(c)&&n(a.value)&&n(b.value))?(f=h(c,a.value,b.value),d=e=A.from_array(["P",f]),[d,e,b.value]):(g=this._transforms[a.tag()][b.tag()](a,b),i=function(){switch(b.tag()){case"P":return b.value;case"D":return null;default:return{L:!0}}}(),g.push(i),g)},a}(),ab.FieldOpTransformer=B,e=function(){function a(){this._transform_rules={},this._default_transformer=new B}var b,c,e,f,g,h,i,j;for(b={},j=["default","local","remote","min","max","sum"],h=0,i=j.length;i>h;h++)e=j[h],b[e]=new B(e);return g=function(a){return _(null!=a),function(b,c){var d,e,f;return f=a(c,b),d=f[0],e=f[1],[e,d]}},c=function(a){return a instanceof Array?a.slice():a},f=function(a,b){return a.tid===b.tid&&a.rowid===b.rowid},a.is_no_op=function(a){var b,c,d;if("U"!==a.tag())return!1;d=a.updates;for(c in d)return b=d[c],!1;return!0},a.compact=function(a){var b,c,d,e;for(b=[],d=0,e=a.length;e>d;d++)c=a[d],this.is_no_op(c)||b.push(c);return b},a.prototype.set_field_transformer=function(a,c,d){var e;return null==(e=this._transform_rules)[a]&&(e[a]={}),this._transform_rules[a][c]=b[d]},a.prototype.get_field_transformer=function(a,c){var d;return a in this._transform_rules?null!=(d=this._transform_rules[a][c])?d:this._default_transformer:b["default"]},a.prototype.transform_ii=function(a,b){var e,g,h;return f(a,b)?(e=function(a){var b,e,f,g,h;f={},h=a.fields;for(e in h)g=h[e],f[e]=A.from_array(["P",c(g)]);return b=d.from_array(["U",a.tid,a.rowid,f]),b.undo_extra={},b},g=e(a),h=e(b),this.transform_uu(g,h)):[[a],[b]]},a.prototype.transform_iu=function(a,b){return f(a,b)?_(!1,"Couldn't have updated a row that hasn't been inserted yet!"):[[a],[b]]},a.prototype.transform_id=function(a,b){return f(a,b)?_(!1,"Couldn't have deleted a row that hasn't been inserted yet!"):[[a],[b]]},a.prototype.transform_ui=g(a.prototype.transform_iu),a.prototype.transform_uu=function(a,b){var c,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(!f(a,b))return[[a],[b]];r=[{},{}],m=r[0],n=r[1],l={},s=a.updates;for(g in s)c=s[g],g in b.updates?(e=b.updates[g],o=null!=(u=a.undo_extra[g])?u:null,p=this.get_field_transformer(a.tid,g),v=p.transform(c,e,o),h=v[0],i=v[1],q=v[2],null!=h&&(m[g]=h,l[g]=null!=q?q:null),null!=i&&(n[g]=i)):(m[g]=c,l[g]=null!=(t=a.undo_extra[g])?t:null);w=b.updates;for(g in w)e=w[g],g in a.updates||(n[g]=e);return j=d.from_array(["U",a.tid,a.rowid,m]),j.undo_extra=l,k=d.from_array(["U",b.tid,b.rowid,n]),[[j],[k]]},a.prototype.transform_ud=function(a,b){return f(a,b)?[[],[b]]:[[a],[b]]},a.prototype.transform_di=g(a.prototype.transform_id),a.prototype.transform_du=g(a.prototype.transform_ud),a.prototype.transform_dd=function(a,b){return f(a,b)?[[],[]]:[[a],[b]]},a}(),ab.ChangeTransformer=e,u=function(){function a(){this._change_transformer=new e}return a.prototype.add_resolution_rule=function(a,b,c){return this._change_transformer.set_field_transformer(a,b,c)},a.prototype._transform_one=function(a,b){var c,d,f,g,h;return c=function(a){switch(a.tag()){case"I":return"i";case"U":return"u";case"D":return"d";default:throw new Error("unrecognized op type "+a.tag())}},g="transform_"+c(a)+c(b),h=this._change_transformer[g](a,b),d=h[0],f=h[1],d=e.compact(d),f=e.compact(f),[d,f]},a.prototype._transform_list=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(0===a.length)return[[],b];if(0===b.length)return[a,[]];for(c=a[0],d=b[0],n=this._transform_one(c,d),f=n[0],g=n[1],o=this._transform_list(a.slice(1),g),e=o[0],g=o[1],j=0,l=e.length;l>j;j++)h=e[j],f.push(h);for(p=this._transform_list(f,b.slice(1)),f=p[0],i=p[1],k=0,m=i.length;m>k;k++)h=i[k],g.push(h);return[f,g]},a.prototype._resolve=function(a,b){var c,d,e,f,g,h,i;for(f=b.slice(),d=[],g=0,h=a.length;h>g;g++)e=a[g],i=this._transform_list(e,f),c=i[0],f=i[1],d.push(c);return[d,f]},a.prototype.resolve=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;for(m=[],r=0,v=a.length;v>r;r++){for(k=a[r],e=[],F=k.changes,l=s=0,w=F.length;w>s;l=++s)g=F[l],i=d.from_array(JSON.parse(JSON.stringify(g))),i.undo_extra=ab.clone(k.undo_extras[l]),e.push(i);m.push(e)}for(p=[],t=0,x=b.length;x>t;t++)for(k=b[t],G=k.changes,u=0,y=G.length;y>u;u++)f=G[u],p.push(f);for(H=this._resolve(m,p),n=H[0],j=H[1],o=[],l=C=0,z=n.length;z>C;l=++C){for(h=n[l],q=function(){var a,b,c;for(c=[],b=0,a=h.length;a>b;b++)g=h[b],c.push(null);return c}(),D=0,A=h.length;A>D;D++)g=h[D],delete g.undo_extra;h.length>0&&o.push(new J(h,q))}for(c={},E=0,B=j.length;B>E;E++)f=j[E],f.tid in c||(c[f.tid]={}),c[f.tid][f.rowid]=!0;return{rebased_deltas:o,affected_records:c}},a}(),ab.DefaultResolver=u,W=function(){function a(){this._waiting=[],this._running=!1}return a.prototype._run_next=function(){var a;this._running||this._waiting.length>0&&(a=this._waiting[0],this._waiting.shift(),this._running=!0,a())},a.prototype.request=function(a){return this._waiting.push(a),this._run_next()},a.prototype.finish=function(){return this._running=!1,setTimeout(this._run_next.bind(this),0)},a}(),f=function(){function a(a){this.consumer=a,this.items=[],this.sync_queue=new W}return a.prototype.consume=function(){var a=this;return this.sync_queue.request(function(){var b;return 0===a.items.length?a.sync_queue.finish():(b=a.items.shift(),a.consumer(b,function(b){if(b)throw b;return a.sync_queue.finish(),a.consume()}))})},a.prototype.push=function(a){return this.items.push(a),this.consume()},a.prototype.run=function(){return this.consume()},a}(),ab.clone=function(a){var b,c,d,e,f,g,h;if(a instanceof Array){for(h=[],f=0,g=a.length;g>f;f++)b=a[f],h.push(ab.clone(b));return h}if(null!=a&&"object"==typeof a){d={};for(c in a)e=a[c],d[c]=ab.clone(e);return d}return a},ab.WEB64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",ab.randomElement=function(a){return a[Math.floor(Math.random()*a.length)]},ab.randomWeb64String=function(a){var b;return function(){var c,d;for(d=[],b=c=0;a>=0?a>c:c>a;b=a>=0?++c:--c)d.push(ab.randomElement(ab.WEB64_ALPHABET));return d}().join("")},ab.uint8ArrayFromBase64String=function(a){var b,c,d,e,f;for(a=a.replace(/-/g,"+").replace(/_/g,"/"),b=x.Util.atob(a),d=b.length,e=new Uint8Array(d),c=f=0;d>=0?d>f:f>d;c=d>=0?++f:--f)e[c]=b.charCodeAt(c);
return e},ab.dbase64FromBase64=function(a){return a.replace(/[+]/g,"-").replace(/[/]/g,"_").replace(/[\=]+$/g,"")},ab.base64StringFromUint8Array=function(a){var b,c,d,e,f;for(c="",e=0,f=a.length;f>e;e++)b=a[e],c+=String.fromCharCode(b);return d=x.Util.btoa(c),ab.dbase64FromBase64(d)},ab.INT64_TAG="dbxInt64",ab.isInt64=function(a){var b;return a&&"object"==typeof a&&a.constructor===Number&&isFinite(a)?(b=a[ab.INT64_TAG],!Y.is_string(b)||"0"!==b&&!ab.nonzero_int64_approximate_regex.test(b)?!1:!0):!1},ab.validateInt64=function(a){var b,c;if(!a&&"object"==typeof a&&a.constructor===Number&&isFinite(a))throw new Error("Not a finite boxed number: "+a);if(c=a[ab.INT64_TAG],!Y.is_string(c)||"0"!==c&&!ab.nonzero_int64_approximate_regex.test(c))throw new Error("Missing or invalid tag in int64: "+c);if(b=parseInt(c,10),b!==Number(a))throw new Error("Tag in int64 does not match value "+Number(a)+": "+c);return a},ab.toDsValue=function(a,b){var c,d;if(null==b&&(b=!0),null===a||"undefined"==typeof a)throw new Error("Bad value: "+a);if(Y.is_string(a))return a;if(Y.is_bool(a))return a;if(Y.is_number(a)){if(null!=a[ab.INT64_TAG])return ab.validateInt64(a),{I:a[ab.INT64_TAG]};if(isFinite(a))return a;if(isNaN(a))return{N:"nan"};if(1/0===Number(a))return{N:"+inf"};if(Number(a)===-1/0)return{N:"-inf"};throw new Error("Unexpected number: "+a)}if(Y.is_array(a)){if(b)return function(){var b,c,e;for(e=[],b=0,c=a.length;c>b;b++)d=a[b],e.push(ab.toDsValue(d,!1));return e}();throw new Error("Nested array not allowed: "+JSON.stringify(a))}if(Y.is_date(a))return c=Math.round(a.getTime()),{T:""+c};if(Y.isUint8Array(a))return{B:ab.base64StringFromUint8Array(a)};throw new Error("Unexpected value: "+Y.safe_to_string(a))},ab.fromDsValue=function(a,b,c,d){if(Y.is_string(d))return d;if(Y.is_bool(d))return d;if(Y.is_number(d))return d;if(Y.is_array(d))return new x.Datastore.List(a,b,c);if("object"!=typeof d)throw new Error("Unexpected value: "+d);if(null!=d.I)return x.Datastore.int64(d.I);if(null==d.N){if(null!=d.B)return ab.uint8ArrayFromBase64String(d.B);if(null!=d.T)return new Date(parseInt(d.T,10));throw new Error("Unexpected object: "+JSON.stringify(d))}switch(d.N){case"nan":return 0/0;case"+inf":return 1/0;case"-inf":return-1/0;default:throw new Error("Unexpected object: "+JSON.stringify(d))}},ab.matchDsValues=function(a,b){var c,d,e,f,g;d=function(a,b){if(null==a)throw new Error("Unexpected object: "+a);return null==b?!1:c(a,b)},c=function(a,b){var c,e,f,g,h,i;if(ab.toDsValue(a),Y.is_string(a)&&Y.is_string(b))return String(a)===String(b);if(Y.is_bool(a)&&Y.is_bool(b))return"object"==typeof a&&(a=a.valueOf()),"object"==typeof b&&(b=b.valueOf()),Boolean(a)===Boolean(b);if(Y.is_number(a)&&(Y.is_number(b)||null!=b.N||null!=b.I))return b=ab.fromDsValue(void 0,void 0,void 0,b),a[ab.INT64_TAG]&&b[ab.INT64_TAG]?(g=[x.Datastore.int64(a),x.Datastore.int64(b)],a=g[0],b=g[1],String(a[ab.INT64_TAG])===String(b[ab.INT64_TAG])):isNaN(a)&&isNaN(b)?!0:Number(a)===Number(b);if(Y.is_array(a)&&Y.is_array(b)){if(a.length!==b.length)return!1;for(c=e=0,h=a.length-1;h>=0?h>=e:e>=h;c=h>=0?++e:--e)if(!d(a[c],b[c]))return!1;return!0}if(Y.is_date(a)&&(Y.is_date(b)||null!=b.T))return null!=b.T&&(b=ab.fromDsValue(void 0,void 0,void 0,b)),a-0===b-0;if(Y.isUint8Array(a)&&(Y.isUint8Array(b)||null!=b.B)){if(null!=b.B&&(b=ab.fromDsValue(void 0,void 0,void 0,b)),a.length!==b.length)return!1;for(c=f=0,i=a.length-1;i>=0?i>=f:f>=i;c=i>=0?++f:--f)if(a[c]!==b[c])return!1;return!0}return!1};for(e in a)if(g=a[e],f=d(g,b[e]),!f)return f;return!0},R=function(){function a(a){this._datastore=a,this._cache={}}return a.prototype.get=function(a,b){return null==this._cache[a]?null:this._cache[a][b]},a.prototype.getOrCreate=function(a,b){var c;return null==this._cache[a]&&(this._cache[a]={}),c=this._cache[a][b],null==c&&(c=this._cache[a][b]=new x.Datastore.Record(this._datastore,a,b)),c},a.prototype.remove=function(a,b){return delete this._cache[a][b],void(Y.is_empty(this._cache[a])&&delete this._cache[a])},a}(),y=function(){function a(){this._registered_handlers=[]}return a.prototype.register=function(a,b){return a.addListener(b),void this._registered_handlers.push([a,b])},a.prototype.unregister_all=function(){var a,b,c,d,e,f;for(e=this._registered_handlers,c=0,d=e.length;d>c;c++)f=e[c],b=f[0],a=f[1],b.removeListener(a);return void 0},a}(),x.Datastore.DatastoreInfo=function(){function a(a,b,c,d){this._dsid=a,this._handle=b,this._info_record_data=c,this._role=d}return a.prototype.toString=function(){return"Datastore.DatastoreInfo("+this._dsid+" "+JSON.stringify(this._info_record_data||{})+" "+this.getEffectiveRole()+")"},a.prototype.getId=function(){return this._dsid},a.prototype.isShareable=function(){return"."===this._dsid[0]},a.prototype.getHandle=function(){return this._handle},a.prototype.getTitle=function(){var a;return null==(null!=(a=this._info_record_data)?a.title:void 0)?null:this._info_record_data.title},a.prototype.getModifiedTime=function(){var a;return null==(null!=(a=this._info_record_data)?a.mtime:void 0)?null:this._info_record_data.mtime},a.prototype.getEffectiveRole=function(){return this.isShareable()&&null!=this._role?x.Datastore._roleFromInt(this._role):x.Datastore.OWNER},a.prototype.isWritable=function(){var a;return a=this.getEffectiveRole(),a===x.Datastore.OWNER||a===x.Datastore.EDITOR},a}(),x.Datastore.DatastoreListChanged=function(){function a(a){this._dsinfos=a}return a.prototype.toString=function(){return"Datastore.DatastoreListChanged("+this._dsinfos.length+" datastores)"},a.prototype.getDatastoreInfos=function(){return this._dsinfos},a}(),x.Datastore.impl.EventSourceWithInitialData=function(a){function b(a){this.options=a,b.__super__.constructor.call(this,a),this._have_event=!1,this._last_event=null,this._listenersChanged=new x.Util.EventSource}return eb(b,a),b.prototype._clearLastEvent=function(){return this._have_event=!1,this._last_event=null},b.prototype.addListener=function(a){var c;return c=b.__super__.addListener.call(this,a),this._have_event&&a(this._last_event),this._listenersChanged.dispatch(this._listeners),c},b.prototype.removeListener=function(a){var c;return c=b.__super__.removeListener.call(this,a),this._listenersChanged.dispatch(this._listeners),c},b.prototype.dispatch=function(a){return this._last_event=a,this._have_event=!0,b.__super__.dispatch.call(this,a)},b}(x.Util.EventSource),h="default",x.Datastore.DatastoreManager=function(){function a(a){var b=this;if(!a.isAuthenticated())throw new Error("DatastoreManager requires an authenticated Dropbox.Client!");this.datastoreListChanged=new x.Datastore.impl.EventSourceWithInitialData,this._flob_client=new C(a),this._lastListDsServerResponse=null,this._obj_manager=new N(new z(this._flob_client),this._flob_client,function(a){return b._handleRemoteDslistUpdate(a)},function(){return b._handleLocalDslistUpdate()})}return a.prototype.datastoreListChanged=null,a.prototype.close=function(){return this._obj_manager.destroy()},a.prototype.toString=function(){return"Datastore.DatastoreManager()"},a.prototype._dispatchDslistEvent=function(){var a;return a=this._lastListDsServerResponse||new H({datastores:[],token:"dummy"}),void this.datastoreListChanged.dispatch(new x.Datastore.DatastoreListChanged(this._getOverlaidDatastoreInfosFromListResponse(a)))},a.prototype._handleLocalDslistUpdate=function(){return void this._dispatchDslistEvent()},a.prototype._handleRemoteDslistUpdate=function(a){return this._lastListDsServerResponse=a,void this._dispatchDslistEvent()},a.prototype._getOverlaidDatastoreInfo=function(a,b){var c,d,e,f,g,h,i,j,k;c=this._obj_manager.getCachedDatastore(a),g=(null!=b?b.info:void 0)||{},f=null==c?ab.clone(g):null==b||b.rev<c.sync_state.get_server_rev()?c.datastore_model.getLocalInfoData():c.datastore_model.updateDatastoreInfo(g);for(d in f)j=f[d],f[d]=Y.is_array(j)?function(){var a,b,c;for(c=[],a=0,b=j.length;b>a;a++)i=j[a],c.push(ab.fromDsValue(null,null,null,i));return c}():ab.fromDsValue(null,null,null,j);return Y.is_empty(f)&&(f=null),e=null!=(null!=b?b.handle:void 0)?b.handle:c.get_handle(),h=null!=(k=null!=b?b.role:void 0)?k:ab.ROLE_OWNER,new x.Datastore.DatastoreInfo(a,e,f,h)},a.prototype._getOverlaidDatastoreInfosFromListResponse=function(a){var b,c,d,e,f,g,h,i,j,k,l;for(H.Type(a),b=this._obj_manager.getAllCachedUndeletedDatastoreIDs(),g={},h=0,j=b.length;j>h;h++)e=b[h],g[e]=null;for(l=a.datastores,i=0,k=l.length;k>i;i++)d=l[i],g[d.dsid]=d;return function(){var a;a=[];for(f in g)c=g[f],a.push(this._getOverlaidDatastoreInfo(f,c));return a}.call(this)},a.prototype._wrapDatastore=function(a,b){return b&&(a._update_mtime(),a.sync()),new x.Datastore(this,a)},a.prototype._getOrCreateDatastoreByDsid=function(a,b){var c=this;return void this._flob_client.get_or_create_db(a,function(d,e){return null!=d?b(d):null==e.handle?b(new Error("get_or_create_datastore failed for "+a)):c._obj_manager.open(a,e.handle,function(a,d){return null!=a?b(a):b(null,c._wrapDatastore(d,e.created))})})},a.prototype._createDatastore=function(a,b,c){var d=this;return void this._flob_client.create_db(a,b,function(b,e){return null!=b?c(b):null==e.handle?c(new Error("create_datastore failed for "+a)):d._obj_manager.open(a,e.handle,function(a,b){return null!=a?c(a):c(null,d._wrapDatastore(b,e.created))})})},a.prototype._getExistingDatastoreByDsid=function(a,b){var c=this;return void this._flob_client.get_db(a,function(d,e){return null!=d?b(d):null==e.handle?b(new Error("Datastore "+a+" not found or not accessible")):c._obj_manager.open(a,e.handle,function(a,d){return null!=a?b(a):b(null,new x.Datastore(c,d))})})},a.prototype.openDefaultDatastore=function(a){return void this._getOrCreateDatastoreByDsid(h,a)},a.prototype.openOrCreateDatastore=function(a,b){return void this._getOrCreateDatastoreByDsid(a,b)},a.prototype.openDatastore=function(a,b){return void this._getExistingDatastoreByDsid(a,b)},a.prototype.createDatastore=function(a){var b,c;return c=ab.randomWeb64String(Math.ceil(256/6)),b="."+ab.dbase64FromBase64(x.Util.sha256(c)),void this._createDatastore(b,c,a)},a.prototype.deleteDatastore=function(a,b){var c=this;return void this._flob_client.get_db(a,function(d,e){return null!=d?b(d):null==e.handle?b(new Error("Datastore "+a+" not found or not accessible")):c._flob_client.delete_db(e.handle,function(a){return b(null!=a?a:null)})})},a.prototype.listDatastores=function(a){var b=this;return null!=this._lastListDsServerResponse?a(null,this._getOverlaidDatastoreInfosFromListResponse(this._lastListDsServerResponse)):void this._flob_client.list_dbs(function(c,d){return null!=c?a(c):a(null,b._getOverlaidDatastoreInfosFromListResponse(d))})},a}(),x.Datastore.List=function(){function a(a,b,c){this._datastore=a,this._record=b,this._field=c}return a.BASE_ITEM_SIZE=20,a.prototype.toString=function(){return"Datastore.List(("+this._record._tid+", "+this._record._rid+", "+this._field+"): "+JSON.stringify(this._array)+")"},a.prototype._array=function(){return this._record._rawFieldValues()[this._field]},a.prototype._checkValid=function(){if(this._record._checkNotDeleted(),!Y.is_array(this._array()))throw new Error("Attempt to operate on deleted list ("+this._record._tid+", "+this._record._rid+", "+this._field+")")},a.prototype._storeUpdate=function(a){var b;return b={},b[this._field]=a,void this._record._storeUpdate(b)},a.prototype._fixInsertionIndex=function(a){var b,c;if(!Y.is_json_number(a))throw new RangeError("Index not a number: "+a);if(b=this._array().length,c=a>=0?a:b+a,c>=0&&b>=c)return c;throw new RangeError("Bad index for list of length "+b+": "+a)},a.prototype._fixIndex=function(a){var b,c;if(c=this._fixInsertionIndex(a),b=this._array().length,b>c)return c;throw new RangeError("Bad index for list of length "+b+": "+a)},a.prototype.get=function(a){var b;return this._checkValid(),b=ab.clone(this._array()[this._fixIndex(a)]),ab.fromDsValue(void 0,void 0,void 0,b)},a.prototype.set=function(a,b){return this._checkValid(),a=this._fixIndex(a),void this._storeUpdate(["LP",a,ab.toDsValue(b,!1)])},a.prototype.length=function(){return this._checkValid(),this._array().length},a.prototype.pop=function(){if(this._checkValid(),0===this._array().length)throw new Error("List is empty");return this.remove(this._array.length-1)},a.prototype.push=function(a){return this._checkValid(),void this.insert(this._array().length,a)},a.prototype.shift=function(){if(this._checkValid(),0===this._array().length)throw new Error("List is empty");return this.remove(0)},a.prototype.unshift=function(a){return void this.insert(0,a)},a.prototype.splice=function(){var a,b,c,d,e,f,g,h,i;if(d=arguments[0],b=arguments[1],a=3<=arguments.length?fb.call(arguments,2):[],this._checkValid(),!Y.is_json_number(b)||0>b)throw new RangeError("Bad second arg to splice: "+d+", "+b);for(d=this._fixInsertionIndex(d),e=this.slice(d,d+b),c=g=0;b>=0?b>g:g>b;c=b>=0?++g:--g)this.remove(d);for(h=0,i=a.length;i>h;h++)f=a[h],this.insert(d,f),d++;return e},a.prototype.move=function(a,b){return this._checkValid(),a=this._fixIndex(a),b=this._fixIndex(b),a===b?void 0:void this._storeUpdate(["LM",a,b])},a.prototype.remove=function(a){var b;return this._checkValid(),a=this._fixIndex(a),b=this.get(a),this._storeUpdate(["LD",a]),b},a.prototype.insert=function(a,b){return this._checkValid(),a=this._fixInsertionIndex(a),void this._storeUpdate(["LI",a,ab.toDsValue(b,!1)])},a.prototype.slice=function(a,b){var c;return this._checkValid(),function(){var d,e,f,g;for(f=this._array().slice(a,b),g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(ab.fromDsValue(void 0,void 0,void 0,c));return g}.call(this)},a.prototype.toArray=function(){var a;return this._checkValid(),function(){var b,c,d,e;for(d=this._array().slice(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(ab.fromDsValue(void 0,void 0,void 0,a));return e}.call(this)},a}(),x.Datastore.Record=function(){function a(a,b,c){this._datastore=a,this._tid=b,this._rid=c,this._deleted=!1,this._record_cache=this._datastore._record_cache,this._managed_datastore=this._datastore._managed_datastore}return a.RECORD_SIZE_LIMIT=102400,a.BASE_RECORD_SIZE=100,a.BASE_FIELD_SIZE=100,a.prototype.get=function(a){var b;return this._checkNotDeleted(),b=this._rawFieldValues(),a in b?ab.fromDsValue(this._datastore,this,a,b[a]):null},a.prototype.set=function(a,b){var c;return c={},c[a]=b,this.update(c)},a.prototype.getOrCreateList=function(a){var b,c;if(this._checkNotDeleted(),c=this._rawFieldValues(),null==c[a])b={},b[a]=["LC"],this._storeUpdate(b),c=this._rawFieldValues();else if(!Y.is_array(c[a]))throw new Error("Can't call getOrCreateList on field "+a+" for record ("+this.tid+", "+this.rid+"): existing value "+c[a]+" is not a list");return ab.fromDsValue(this._datastore,this,a,c[a])},a.prototype.getFields=function(){var a,b,c,d;this._checkNotDeleted(),a={},d=this._rawFieldValues();for(b in d)c=d[b],a[b]=ab.fromDsValue(this._datastore,this,b,c);return a},a.prototype.getSize=function(){return this._managed_datastore.get_record_size(this._tid,this._rid)},a.prototype.update=function(a){var b,c,d;this._datastore._checkWritable(),this._checkNotDeleted(),b={};for(c in a)d=a[c],null!=d?b[c]=["P",ab.toDsValue(d)]:null!=this.get(c)&&(b[c]=["D"]);return Y.is_empty(b)||this._storeUpdate(b),this},a.prototype.deleteRecord=function(){var a;return this._datastore._checkWritable(),this._checkNotDeleted(),this._deleted=!0,this._record_cache.remove(this._tid,this._rid),a=d.from_array(["D",this._tid,this._rid]),this._managed_datastore.perform_local_change(a),this._datastore._recordsChangedLocally([this]),this},a.prototype.has=function(a){var b;return this._checkNotDeleted(),b=this._rawFieldValues(),a in b},a.prototype.getId=function(){return this._rid},a.prototype.getTable=function(){return this._datastore.getTable(this._tid)},a.prototype.isDeleted=function(){return this._deleted},a.prototype.toString=function(){var a;return a=this.isDeleted()?"deleted":JSON.stringify(this.getFields()),"Datastore.Record(("+this._tid+", "+this._rid+"): "+a+")"},a.prototype._rawFieldValues=function(){return this._managed_datastore.query(this._tid,this._rid)},a.prototype._storeUpdate=function(a){var b;b=d.from_array(["U",this._tid,this._rid,a]),this._managed_datastore.perform_local_change(b),this._datastore._recordsChangedLocally([this])},a.isValidId=function(a){var b;return b=new RegExp(Y.SS_ID_REGEX),Y.is_string(a)&&b.test(a)},a.prototype._checkNotDeleted=function(){if(this._deleted)throw new Error("Attempt to operate on deleted record ("+this._tid+", "+this._rid+")")},a}(),x.Datastore.RecordsChanged=function(){function a(a,b){this._recordsByTable=a,this._local=b}return a.prototype.toString=function(){var a,b,c,d,e,f,g;e=0,c=0,g=this._recordsByTable;for(f in g)a=g[f],e+=1,c+=a.length;return d=""+e+" "+(1===e?"table":"tables"),b=""+c+" "+(1===c?"record":"records"),"Datastore.RecordsChanged("+b+" in "+d+" changed "+(this._local?"locally":"remotely")+")"},a._fromRecordList=function(b,c){var d,e,f,g,h;for(e={},g=0,h=b.length;h>g;g++)d=b[g],f=d._tid,null==e[f]&&(e[f]=[]),e[f].push(d);return new a(e,c)},a.prototype.affectedRecordsByTable=function(){return this._recordsByTable},a.prototype.affectedRecordsForTable=function(a){var b;return null!=(b=this._recordsByTable[a])?b:[]},a.prototype.isLocal=function(){return this._local},a}(),T=x.Datastore.RecordsChanged,x.Datastore.Table=function(){function a(a,b){this._datastore=a,this._tid=b,this._record_cache=this._datastore._record_cache,this._managed_datastore=this._datastore._managed_datastore}return a.prototype.getId=function(){return this._tid},a.prototype.get=function(a){var b,c;if(!x.Datastore.Record.isValidId(a))throw new Error("Invalid record ID: "+a);return c=this._record_cache.get(this._tid,a),null!=c?(_(!c._deleted),c):(b=this._managed_datastore.query(this._tid,a),null==b?null:this._record_cache.getOrCreate(this._tid,a))},a.prototype.getOrInsert=function(a,b){var c;return this._datastore._checkWritable(),c=this.get(a),c?c:this._insertWithId(a,b)},a.prototype.insert=function(a){var b;return this._datastore._checkWritable(),b=this._datastore._generateRid(),_(null==this.get(b)),this._insertWithId(b,a)},a.prototype.query=function(a){var b,c,d,e,f,g,h;for(f=this._managed_datastore.list_rows_for_table(this._tid),d=[],g=0,h=f.length;h>g;g++)e=f[g],b=this._managed_datastore.query(this._tid,e),(null==a||ab.matchDsValues(a,b))&&(c=this.get(e),_(null!=c),d.push(c));return d},a.prototype.setResolutionRule=function(a,b){if("remote"!==b&&"local"!==b&&"min"!==b&&"max"!==b&&"sum"!==b)throw new Error(""+b+" is not a valid resolution rule. Valid rules are 'remote', 'local', 'min', 'max', and 'sum'.");return this._managed_datastore.resolver.add_resolution_rule(this._tid,a,b),this},a.isValidId=function(a){var b;return b=new RegExp(Y.SS_ID_REGEX),Y.is_string(a)&&b.test(a)},a.prototype.toString=function(){return"Datastore.Table("+this._tid+")"},a.prototype._insertWithId=function(a,b){var c,e,f,g,h;e={};for(f in b)h=b[f],e[f]=ab.toDsValue(h);return c=d.from_array(["I",this._tid,a,e]),this._managed_datastore.perform_local_change(c),g=this._record_cache.getOrCreate(this._tid,a),this._datastore._recordsChangedLocally([g]),g},a}(),x.File.ShareUrl=function(){function a(a,b){this.url=a.url,this.expiresAt=x.Util.parseDate(a.expires),this.isDirect=b===!0?!0:b===!1?!1:"direct"in a?a.direct:Date.now()-this.expiresAt<=864e5,this.isPreview=!this.isDirect,this._json=null}return a.parse=function(a,b){return a&&"object"==typeof a?new x.File.ShareUrl(a,b):a},a.prototype.url=null,a.prototype.expiresAt=null,a.prototype.isDirect=null,a.prototype.isPreview=null,a.prototype.json=function(){return this._json||(this._json={url:this.url,expires:this.expiresAt.toUTCString(),direct:this.isDirect})},a}(),x.File.CopyReference=function(){function a(a){"object"==typeof a?(this.tag=a.copy_ref,this.expiresAt=x.Util.parseDate(a.expires),this._json=a):(this.tag=a,this.expiresAt=new Date(1e3*Math.ceil(Date.now()/1e3)),this._json=null)}return a.parse=function(a){return!a||"object"!=typeof a&&"string"!=typeof a?a:new x.File.CopyReference(a)},a.prototype.tag=null,a.prototype.expiresAt=null,a.prototype.json=function(){return this._json||(this._json={copy_ref:this.tag,expires:this.expiresAt.toUTCString()})},a}(),x.File.Stat=function(){function a(a){var b,c,d,e;switch(this._json=a,this.path=a.path,"/"!==this.path.substring(0,1)&&(this.path="/"+this.path),b=this.path.length-1,b>=0&&"/"===this.path.substring(b)&&(this.path=this.path.substring(0,b)),c=this.path.lastIndexOf("/"),this.name=this.path.substring(c+1),this.isFolder=a.is_dir||!1,this.isFile=!this.isFolder,this.isRemoved=a.is_deleted||!1,this.typeIcon=a.icon,this.modifiedAt=(null!=(d=a.modified)?d.length:void 0)?x.Util.parseDate(a.modified):null,this.clientModifiedAt=(null!=(e=a.client_mtime)?e.length:void 0)?x.Util.parseDate(a.client_mtime):null,a.root){case"dropbox":this.inAppFolder=!1;break;case"app_folder":this.inAppFolder=!0;break;default:this.inAppFolder=null}this.size=a.bytes||0,this.humanSize=a.size||"",this.hasThumbnail=a.thumb_exists||!1,this.versionTag=a.rev,this.contentHash=a.hash||null,this.mimeType=this.isFolder?a.mime_type||"inode/directory":a.mime_type||"application/octet-stream"}return a.parse=function(a){return a&&"object"==typeof a?new x.File.Stat(a):a},a.prototype.path=null,a.prototype.name=null,a.prototype.inAppFolder=null,a.prototype.isFolder=null,a.prototype.isFile=null,a.prototype.isRemoved=null,a.prototype.typeIcon=null,a.prototype.versionTag=null,a.prototype.contentHash=null,a.prototype.mimeType=null,a.prototype.size=null,a.prototype.humanSize=null,a.prototype.hasThumbnail=null,a.prototype.modifiedAt=null,a.prototype.clientModifiedAt=null,a.prototype.json=function(){return this._json},a}(),x.Http.AppInfo=function(){function a(a,b){var c;this.name=a.name,this._icons=a.icons,c=a.permissions||{},this.canUseDatastores=!!c.datastores,this.canUseFiles=!!c.files,this.canUseFullDropbox="full_dropbox"===c.files,this.hasAppFolder="app_folder"===c.files,this.key=b?b:a.key||null}return a.parse=function(a,b){return a?new x.Http.AppInfo(a,b):a},a.prototype.name=void 0,a.prototype.key=void 0,a.prototype.canUseDatastores=void 0,a.prototype.canUseFiles=void 0,a.prototype.hasAppFolder=void 0,a.prototype.canUseFullDropbox=void 0,a.prototype.icon=function(a,b){return b||(b=a),this._icons[""+a+"x"+b]||null},a.ICON_SMALL=64,a.ICON_LARGE=256,a}(),x.Http.PulledChanges=function(){function a(a){var b;this.blankSlate=a.reset||!1,this.cursorTag=a.cursor,this.shouldPullAgain=a.has_more,this.shouldBackOff=!this.shouldPullAgain,this.changes=a.cursor&&a.cursor.length?function(){var c,d,e,f;for(e=a.entries,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(x.Http.PulledChange.parse(b));return f}():[]}return a.parse=function(a){return a&&"object"==typeof a?new x.Http.PulledChanges(a):a},a.prototype.blankSlate=void 0,a.prototype.cursorTag=void 0,a.prototype.changes=void 0,a.prototype.shouldPullAgain=void 0,a.prototype.shouldBackOff=void 0,a.prototype.cursor=function(){return this.cursorTag},a}(),x.Http.PulledChange=function(){function a(a){this.path=a[0],this.stat=x.File.Stat.parse(a[1]),this.stat?this.wasRemoved=!1:(this.stat=null,this.wasRemoved=!0)}return a.parse=function(a){return a&&"object"==typeof a?new x.Http.PulledChange(a):a},a.prototype.path=void 0,a.prototype.wasRemoved=void 0,a.prototype.stat=void 0,a}(),x.Http.PollResult=function(){function a(a){this.hasChanges=a.changes,this.retryAfter=a.backoff||0}return a.parse=function(a){return a?new x.Http.PollResult(a):a},a.prototype.hasChanges=void 0,a.prototype.retryAfter=void 0,a}(),x.Http.RangeInfo=function(){function a(a){var b;(b=/^bytes (\d*)-(\d*)\/(.*)$/.exec(a))?(this.start=parseInt(b[1]),this.end=parseInt(b[2]),this.size="*"===b[3]?null:parseInt(b[3])):(this.start=0,this.end=0,this.size=null)}return a.parse=function(a){return"string"==typeof a?new x.Http.RangeInfo(a):a},a.prototype.start=null,a.prototype.size=null,a.prototype.end=null,a}(),x.Http.UploadCursor=function(){function a(a){this.replace(a)}return a.parse=function(a){return!a||"object"!=typeof a&&"string"!=typeof a?a:new x.Http.UploadCursor(a)},a.prototype.tag=null,a.prototype.offset=null,a.prototype.expiresAt=null,a.prototype.json=function(){return this._json||(this._json={upload_id:this.tag,offset:this.offset,expires:this.expiresAt.toUTCString()})},a.prototype.replace=function(a){return"object"==typeof a?(this.tag=a.upload_id||null,this.offset=a.offset||0,this.expiresAt=x.Util.parseDate(a.expires)||Date.now(),this._json=a):(this.tag=a||null,this.offset=0,this.expiresAt=new Date(1e3*Math.floor(Date.now()/1e3)),this._json=null),this},a}(),"function"==typeof x.Env.global.atob&&"function"==typeof x.Env.global.btoa?(x.Util.atob=function(a){return x.Env.global.atob(a)},x.Util.btoa=function(a){return x.Env.global.btoa(a)}):x.Env.global.require&&x.Env.global.Buffer?(x.Util.atob=function(a){var b,c;return b=new Buffer(a,"base64"),function(){var a,d,e;for(e=[],c=a=0,d=b.length;d>=0?d>a:a>d;c=d>=0?++a:--a)e.push(String.fromCharCode(b[c]));return e}().join("")},x.Util.btoa=function(a){var b,c;return b=new Buffer(function(){var b,d,e;for(e=[],c=b=0,d=a.length;d>=0?d>b:b>d;c=d>=0?++b:--b)e.push(a.charCodeAt(c));return e}()),b.toString("base64")}):!function(){var a,b,c;return b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=function(a,c,d){var e,f;for(f=3-c,a<<=8*f,e=3;e>=f;)d.push(b.charAt(63&a>>6*e)),e-=1;for(e=c;3>e;)d.push("="),e+=1;return null},a=function(a,b,c){var d,e;for(e=4-b,a<<=6*e,d=2;d>=e;)c.push(String.fromCharCode(255&a>>8*d)),d-=1;return null},x.Util.btoa=function(a){var b,d,e,f,g,h;for(f=[],b=0,d=0,e=g=0,h=a.length;h>=0?h>g:g>h;e=h>=0?++g:--g)b=b<<8|a.charCodeAt(e),d+=1,3===d&&(c(b,d,f),b=d=0);return d>0&&c(b,d,f),f.join("")},x.Util.atob=function(c){var d,e,f,g,h,i,j;for(h=[],d=0,f=0,g=i=0,j=c.length;(j>=0?j>i:i>j)&&(e=c.charAt(g),"="!==e);g=j>=0?++i:--i)d=d<<6|b.indexOf(e),f+=1,4===f&&(a(d,f,h),d=f=0);return f>0&&a(d,f,h),h.join("")}}(),function(){var a,b,c,d,e,f,g,h,i,j,k;if(x.Util.hmac=function(b,d){return a(c(i(b),i(d),b.length,d.length))},x.Util.sha1=function(b){return a(e(i(b),b.length))},x.Util.sha256=function(b){return a(f(i(b),b.length))},x.Env.require)try{b=x.Env.require("crypto"),b.createHmac&&b.createHash&&(x.Util.hmac=function(a,c){var d;return d=b.createHmac("sha1",c),d.update(a),d.digest("base64")},x.Util.sha1=function(a){var c;return c=b.createHash("sha1"),c.update(a),c.digest("base64")},x.Util.sha256=function(a){var c;return c=b.createHash("sha256"),c.update(a),c.digest("base64")})}catch(l){d=l}return c=function(a,b,c,d){var f,g,h,i;return b.length>16&&(b=e(b,d)),h=function(){var a,c;for(c=[],g=a=0;16>a;g=++a)c.push(909522486^b[g]);return c}(),i=function(){var a,c;for(c=[],g=a=0;16>a;g=++a)c.push(1549556828^b[g]);return c}(),f=e(h.concat(a),64+c),e(i.concat(f),84)},e=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(a[b>>2]|=1<<31-((3&b)<<3),a[(b+8>>6<<4)+15]=b<<3,q=Array(80),c=1732584193,e=4023233417,g=2562383102,i=271733878,k=3285377520,m=0,o=a.length;o>m;){for(d=c,f=e,h=g,j=i,l=k,n=s=0;80>s;n=++s)16>n?q[n]=0|a[m+n<<2>>2]:(p=(0|q[n-3<<2>>2])^(0|q[n-8<<2>>2])^(0|q[n-14<<2>>2])^(0|q[n-16<<2>>2]),q[n]=p<<1|p>>>31),r=0|(0|(c<<5|c>>>27)+k)+q[n<<2>>2],r=20>n?0|r+(0|(e&g|~e&i)+1518500249):40>n?0|r+(0|(e^g^i)+1859775393):60>n?0|(0|r+((e&g|e&i|g&i)-1894007588)):0|r+(0|(e^g^i)-899497514),k=i,i=g,g=e<<30|e>>>2,e=c,c=r;c=0|d+c,e=0|f+e,g=0|h+g,i=0|j+i,k=0|l+k,m=0|m+16}return[c,e,g,i,k]},f=function(a,b){var c,d,e,f,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;for(a[b>>2]|=1<<31-((3&b)<<3),a[(b+8>>6<<4)+15]=b<<3,G=Array(80),c=g[0],e=g[1],i=g[2],l=g[3],n=g[4],p=g[5],r=g[6],x=g[7],z=0,B=a.length;B>z;){for(d=c,f=e,j=i,m=l,o=n,q=p,s=r,y=x,A=J=0;64>J;A=++J)16>A?F=G[A]=0|a[z+A<<2>>2]:(u=0|G[A-15<<2>>2],t=(u<<25|u>>>7)^(u<<14|u>>>18)^u>>>3,w=0|G[A-2<<2>>2],v=(w<<15|w>>>17)^(w<<13|w>>>19)^w>>>10,F=G[A]=0|(0|t+(0|G[A-7<<2>>2]))+(0|v+(0|G[A-16<<2>>2]))),k=n&p^~n&r,C=c&e^c&i^e&i,D=(c<<30|c>>>2)^(c<<19|c>>>13)^(c<<10|c>>>22),E=(n<<26|n>>>6)^(n<<21|n>>>11)^(n<<7|n>>>25),H=0|(0|(0|x+E)+(0|k+F))+(0|h[A<<2>>2]),I=0|D+C,x=r,r=p,p=n,n=0|l+H,l=i,i=e,e=c,c=0|H+I;c=0|d+c,e=0|f+e,i=0|j+i,l=0|m+l,n=0|o+n,p=0|q+p,r=0|s+r,x=0|y+x,z+=16}return[c,e,i,l,n,p,r,x]},j=function(a){return 0>a&&(a=4*(1<<30)+a),a.toString(16)},g=[],h=[],function(){var a,b,c,d,e,f,i;for(b=function(a){return 0|4294967296*(a-Math.floor(a))},e=2,i=[],c=f=0;64>f;c=++f){for(;;){for(d=!0,a=2;e>=a*a;){if(0===e%a){d=!1;break}a+=1}if(d)break;e+=1}8>c&&(g[c]=b(Math.pow(e,.5))),h[c]=b(Math.pow(e,1/3)),i.push(e+=1)}return i}(),a=function(a){var b,c,d,e,f;for(e="",b=0,d=4*a.length;d>b;)c=b,f=(255&a[c>>2]>>(3-(3&c)<<3))<<16,c+=1,f|=(255&a[c>>2]>>(3-(3&c)<<3))<<8,c+=1,f|=255&a[c>>2]>>(3-(3&c)<<3),e+=k[63&f>>18],e+=k[63&f>>12],b+=1,e+=b>=d?"=":k[63&f>>6],b+=1,e+=b>=d?"=":k[63&f],b+=1;return e},k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=function(a){var b,c,d,e,f;for(b=[],d=255,c=e=0,f=a.length;f>=0?f>e:e>f;c=f>=0?++e:--e)b[c>>2]|=(a.charCodeAt(c)&d)<<(3-(3&c)<<3);return b}}(),x.Util.Oauth=function(){function a(a){this._id=null,this._secret=null,this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this._appHash=null,this._loaded=null,this.setCredentials(a)}return a.prototype.setCredentials=function(a){if(a.key)this._id=a.key;else{if(!a.token)throw new Error("No API key supplied");this._id=null}return this._secret=a.secret||null,this._appHash=null,this._error=null,this._loaded=!0,this.reset(),a.token?(this._token=a.token,a.tokenKey&&(this._tokenKey=a.tokenKey,this._tokenKid=a.tokenKid)):a.oauthCode?this._authCode=a.oauthCode:a.oauthStateParam&&(this._stateParam=a.oauthStateParam),this},a.prototype.credentials=function(){var a;return a={},this._id&&(a.key=this._id),this._secret&&(a.secret=this._secret),null!==this._token?(a.token=this._token,this._tokenKey&&(a.tokenKey=this._tokenKey,a.tokenKid=this._tokenKid)):null!==this._authCode?a.oauthCode=this._authCode:null!==this._stateParam&&(a.oauthStateParam=this._stateParam),a},a.prototype.step=function(){return null!==this._token?x.Client.DONE:null!==this._authCode?x.Client.AUTHORIZED:null!==this._stateParam?this._loaded?x.Client.PARAM_LOADED:x.Client.PARAM_SET:null!==this._error?x.Client.ERROR:x.Client.RESET},a.prototype.setAuthStateParam=function(a){if(null===this._id)throw new Error("No API key supplied, cannot do authorization");return this.reset(),this._loaded=!1,this._stateParam=a,this},a.prototype.checkAuthStateParam=function(a){return this._stateParam===a&&null!==this._stateParam},a.prototype.authStateParam=function(){return this._stateParam},a.prototype.error=function(){return this._error},a.prototype.processRedirectParams=function(a){var b;if(a.error){if(null===this._id)throw new Error("No API key supplied, cannot process errors");return this.reset(),this._error=new x.AuthError(a),!0}if(a.code){if(null===this._id)throw new Error("No API key supplied, cannot do Authorization Codes");return this.reset(),this._loaded=!1,this._authCode=a.code,!0}if(b=a.token_type){if(b=b.toLowerCase(),"bearer"!==b&&"mac"!==b)throw new Error("Unimplemented token type "+b);if(this.reset(),this._loaded=!1,"mac"===b){if("hmac-sha-1"!==a.mac_algorithm)throw new Error("Unimplemented MAC algorithms "+a.mac_algorithm);this._tokenKey=a.mac_key,this._tokenKid=a.kid}return this._token=a.access_token,!0}return!1},a.prototype.authHeader=function(a,b,c){var d,e;return null===this._token?(e=x.Util.btoa(null===this._secret?""+this._id+":":""+this._id+":"+this._secret),"Basic "+e):null===this._tokenKey?"Bearer "+this._token:(d=this.macParams(a,b,c),"MAC kid="+d.kid+" ts="+d.ts+" "+("access_token="+this._token+" mac="+d.mac))},a.prototype.addAuthParams=function(a,b,c){var d;return null===this._token?(c.client_id=this._id,null!==this._secret&&(c.client_secret=this._secret)):(null!==this._tokenKey&&(d=this.macParams(a,b,c),c.kid=d.kid,c.ts=d.ts,c.mac=d.mac),c.access_token=this._token),c},a.prototype.authorizeUrlParams=function(a,b){var c;if("token"!==a&&"code"!==a)throw new Error("Unimplemented /authorize response type "+a);
return c={client_id:this._id,state:this._stateParam,response_type:a},b&&(c.redirect_uri=b),c},a.prototype.accessTokenParams=function(a){var b;return b={grant_type:"authorization_code",code:this._authCode},a&&(b.redirect_uri=a),b},a.queryParamsFromUrl=function(a){var b,c,d,e,f,g,h,i,j,k;if(e=/^[^?#]+(\?([^\#]*))?(\#(.*))?$/.exec(a),!e)return{};for(h=e[2]||"","/"===h.substring(0,1)&&(h=h.substring(1)),b=e[4]||"",c=b.indexOf("?"),-1!==c&&(b=b.substring(c+1)),"/"===b.substring(0,1)&&(b=b.substring(1)),g={},k=h.split("&").concat(b.split("&")),i=0,j=k.length;j>i;i++)d=k[i],f=d.indexOf("="),-1!==f&&(g[decodeURIComponent(d.substring(0,f))]=decodeURIComponent(d.substring(f+1)));return g},a.prototype.macParams=function(a,b,c){var d,e;return d={kid:this._tokenKid,ts:x.Util.Oauth.timestamp()},e=a.toUpperCase()+"&"+x.Util.Xhr.urlEncodeValue(b)+"&"+x.Util.Xhr.urlEncodeValue(x.Util.Xhr.urlEncode(c)),d.mac=x.Util.hmac(e,this._tokenKey),d},a.prototype.appHash=function(){return this._appHash?this._appHash:this._appHash=x.Util.sha1("oauth2-"+this._id).replace(/[\/+=]/g,"")},a.prototype.reset=function(){return this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this},a.timestamp=function(){return Math.floor(Date.now()/1e3)},a.randomAuthStateParam=function(){return["oas",Date.now().toString(36),Math.random().toString(36)].join("_")},a}(),null==Date.now&&(x.Util.Oauth.timestamp=function(){return Math.floor((new Date).getTime()/1e3)}),2274814865e3===new Date("Fri, 31 Jan 2042 21:01:05 +0000").valueOf()?x.Util.parseDate=function(a){return new Date(a)}:2274814865e3===Date.parse("Fri, 31 Jan 2042 21:01:05 +0000")?x.Util.parseDate=function(a){return new Date(Date.parse(a))}:!function(){var a,b;return b=/^\w+\, (\d+) (\w+) (\d+) (\d+)\:(\d+)\:(\d+) (\+\d+|UTC|GMT)$/,a={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11},x.Util.parseDate=function(c){var d;return(d=b.exec(c))?new Date(Date.UTC(parseInt(d[3]),a[d[2]],parseInt(d[1]),parseInt(d[4]),parseInt(d[5]),parseInt(d[6]),0)):0/0}}(),x.Util.countUtf8Bytes=function(a){var b,c,d,e,f;for(b=0,d=e=0,f=a.length;f>=0?f>e:e>f;d=f>=0?++e:--e)c=a.charCodeAt(d),127>=c?b+=1:2047>=c?b+=2:c>=55296&&57343>=c?b+=2:65535>=c?b+=3:_(!1);return b},x.Env.global.XMLHttpRequest?(!x.Env.global.XDomainRequest||"withCredentials"in new XMLHttpRequest?(r=XMLHttpRequest,q=!1,o="undefined"!=typeof FormData&&-1===navigator.userAgent.indexOf("Firefox")):(r=XDomainRequest,q=!0,o=!1),p=!0):(r=x.Env.require("xhr2"),q=!1,o=!1,p=!1),x.Env.global.Uint8Array)if(Object.getPrototypeOf?n=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array(0))).constructor:Object.__proto__&&(n=new Uint8Array(0).__proto__.__proto__.constructor),x.Env.global.Blob){try{!function(){return 2===new Blob([new Uint8Array(2)]).size?(t=!0,s=!0):(s=!1,t=2===new Blob([new ArrayBuffer(2)]).size)}()}catch(gb){s=!1,t=!1,x.Env.global.WebKitBlobBuilder&&-1!==navigator.userAgent.indexOf("Android")&&(o=!1)}n===Object&&(s=!1)}else t=!1,s=!0;else n=null,t=!1,s=!1;x.Util.Xhr=function(){function a(a,b){this.method=a,this.isGet="GET"===this.method,this.url=b,this.wantHeaders=!1,this.headers={},this.params=null,this.body=null,this.preflight=!(this.isGet||"POST"===this.method),this.signed=!1,this.completed=!1,this.responseType=null,this.callback=null,this.xhr=null,this.onError=null}return a.Request=r,a.ieXdr=q,a.canSendForms=o,a.doesPreflight=p,a.ArrayBufferView=n,a.sendArrayBufferView=s,a.wrapBlob=t,a.prototype.xhr=null,a.prototype.onError=null,a.prototype.setParams=function(a){if(this.signed)throw new Error("setParams called after addOauthParams or addOauthHeader");if(this.params)throw new Error("setParams cannot be called twice");return this.params=a,this},a.prototype.setCallback=function(a){return this.callback=a,this},a.prototype.signWithOauth=function(a,b){return x.Util.Xhr.ieXdr?this.addOauthParams(a):this.preflight||!x.Util.Xhr.doesPreflight?this.addOauthHeader(a):this.isGet&&b?this.addOauthHeader(a):this.addOauthParams(a)},a.prototype.addOauthParams=function(a){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),a.addAuthParams(this.method,this.url,this.params),this.signed=!0,this},a.prototype.addOauthHeader=function(a){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),this.signed=!0,this.setHeader("Authorization",a.authHeader(this.method,this.url,this.params))},a.prototype.setBody=function(a){if(this.isGet)throw new Error("setBody cannot be called on GET requests");if(null!==this.body)throw new Error("Request already has a body");return"string"==typeof a||"undefined"!=typeof FormData&&a instanceof FormData||(this.headers["Content-Type"]="application/octet-stream",this.preflight=!0),this.body=a,this},a.prototype.setResponseType=function(a){return this.responseType=a,this},a.prototype.setHeader=function(a,b){var c;if(this.headers[a])throw c=this.headers[a],new Error("HTTP header "+a+" already set to "+c);if("Content-Type"===a)throw new Error("Content-Type is automatically computed based on setBody");return this.preflight=!0,this.headers[a]=b,this},a.prototype.reportResponseHeaders=function(){return this.wantHeaders=!0},a.prototype.setFileField=function(a,b,c,d){var e,f,g,h,i;if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("setFileField cannot be called on GET requests");if("object"==typeof c){"undefined"!=typeof ArrayBuffer&&(c instanceof ArrayBuffer?x.Util.Xhr.sendArrayBufferView&&(c=new Uint8Array(c)):!x.Util.Xhr.sendArrayBufferView&&0===c.byteOffset&&c.buffer instanceof ArrayBuffer&&(c=c.buffer)),d||(d="application/octet-stream");try{c=new Blob([c],{type:d})}catch(j){f=j,window.WebKitBlobBuilder&&(h=new WebKitBlobBuilder,h.append(c),(e=h.getBlob(d))&&(c=e))}"undefined"!=typeof File&&c instanceof File&&(c=new Blob([c],{type:c.type})),i=c instanceof Blob}else i=!1;return i?(this.body=new FormData,this.body.append(a,c,b)):(d||(d="application/octet-stream"),g=this.multipartBoundary(),this.headers["Content-Type"]="multipart/form-data; boundary="+g,this.body=["--",g,"\r\n",'Content-Disposition: form-data; name="',a,'"; filename="',b,'"\r\n',"Content-Type: ",d,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",c,"\r\n","--",g,"--","\r\n"].join(""))},a.prototype.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")},a.prototype.paramsToUrl=function(){var a;return this.params&&(a=x.Util.Xhr.urlEncode(this.params),0!==a.length&&(this.url=[this.url,"?",a].join("")),this.params=null),this},a.prototype.paramsToBody=function(){if(this.params){if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("paramsToBody cannot be called on GET requests");this.headers["Content-Type"]="application/x-www-form-urlencoded",this.body=x.Util.Xhr.urlEncode(this.params),this.params=null}return this},a.prototype.prepare=function(){var a,b,c,d,e=this;if(b=x.Util.Xhr.ieXdr,this.isGet||null!==this.body||b?(this.paramsToUrl(),null!==this.body&&"string"==typeof this.body&&(this.headers["Content-Type"]="text/plain; charset=utf8")):this.paramsToBody(),this.xhr=new x.Util.Xhr.Request,b?(this.xhr.onload=function(){return e.onXdrLoad()},this.xhr.onerror=function(){return e.onXdrError()},this.xhr.ontimeout=function(){return e.onXdrError()},this.xhr.onprogress=function(){}):this.xhr.onreadystatechange=function(){return e.onReadyStateChange()},this.xhr.open(this.method,this.url,!0),!b){d=this.headers;for(a in d)cb.call(d,a)&&(c=d[a],this.xhr.setRequestHeader(a,c))}return this.responseType&&("b"===this.responseType?this.xhr.overrideMimeType&&this.xhr.overrideMimeType("text/plain; charset=x-user-defined"):this.xhr.responseType=this.responseType),this},a.prototype.send=function(a){var b,c;if(this.callback=a||this.callback,null!==this.body){b=this.body,x.Util.Xhr.sendArrayBufferView?b instanceof ArrayBuffer&&(b=new Uint8Array(b)):0===b.byteOffset&&b.buffer instanceof ArrayBuffer&&(b=b.buffer);try{this.xhr.send(b)}catch(d){if(c=d,x.Util.Xhr.sendArrayBufferView||!x.Util.Xhr.wrapBlob)throw c;b=new Blob([b],{type:"application/octet-stream"}),this.xhr.send(b)}}else this.xhr.send();return this},a.urlEncode=function(a){var b,c,d;b=[];for(c in a)d=a[c],b.push(this.urlEncodeValue(c)+"="+this.urlEncodeValue(d));return b.sort().join("&")},a.urlEncodeValue=function(a){return encodeURIComponent(a.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},a.urlDecode=function(a){var b,c,d,e,f,g;for(c={},g=a.split("&"),e=0,f=g.length;f>e;e++)d=g[e],b=d.split("="),c[decodeURIComponent(b[0])]=decodeURIComponent(b[1]);return c},a.prototype.onReadyStateChange=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(4!==this.xhr.readyState)return!0;if(this.completed)return!0;if(this.completed=!0,this.xhr.status<200||this.xhr.status>=300)return b=new x.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(b,this.callback):this.callback(b),!0;if(this.wantHeaders?(a=this.xhr.getAllResponseHeaders(),g=a?x.Util.Xhr.parseResponseHeaders(a):this.guessResponseHeaders(),k=g["x-dropbox-metadata"]):(g=void 0,k=this.xhr.getResponseHeader("x-dropbox-metadata")),null!=k?k.length:void 0)try{j=JSON.parse(k)}catch(p){if(i=p,f=k.search(/\}\,\s*\{/),-1!==f)try{k=k.substring(0,f+1),j=JSON.parse(k)}catch(p){i=p,j=void 0}else j=void 0}else j=void 0;if(this.responseType){if("b"===this.responseType){for(e=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,c=[],h=n=0,o=e.length;o>=0?o>n:n>o;h=o>=0?++n:--n)c.push(String.fromCharCode(255&e.charCodeAt(h)));m=c.join(""),this.callback(null,m,j,g)}else this.callback(null,this.xhr.response,j,g);return!0}switch(m=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,d=this.xhr.getResponseHeader("Content-Type"),d&&(l=d.indexOf(";"),-1!==l&&(d=d.substring(0,l))),d){case"application/x-www-form-urlencoded":this.callback(null,x.Util.Xhr.urlDecode(m),j,g);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(m),j,g);break;default:this.callback(null,m,j,g)}return!0},a.parseResponseHeaders=function(a){var b,c,d,e,f,g,h,i;for(d={},c=a.split("\n"),h=0,i=c.length;i>h;h++)e=c[h],b=e.indexOf(":"),f=e.substring(0,b).trim().toLowerCase(),g=e.substring(b+1).trim(),d[f]=g;return d},a.prototype.guessResponseHeaders=function(){var a,b,c,d,e,f;for(a={},f=["cache-control","content-language","content-range","content-type","expires","last-modified","pragma","x-dropbox-metadata"],d=0,e=f.length;e>d;d++)b=f[d],c=this.xhr.getResponseHeader(b),c&&(a[b]=c);return a},a.prototype.onXdrLoad=function(){var a,b,c;if(this.completed)return!0;if(this.completed=!0,c=this.xhr.responseText,a=this.wantHeaders?{"content-type":this.xhr.contentType}:void 0,b=void 0,this.responseType)return this.callback(null,c,b,a),!0;switch(this.xhr.contentType){case"application/x-www-form-urlencoded":this.callback(null,x.Util.Xhr.urlDecode(c),b,a);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(c),b,a);break;default:this.callback(null,c,b,a)}return!0},a.prototype.onXdrError=function(){var a;return this.completed?!0:(this.completed=!0,a=new x.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(a,this.callback):this.callback(a),!0)},a}(),$="X-Dropbox-User-Agent",Q="X-Dropbox-Request-Id",x.DatastoresClient={_dispatchDatastoreXhr:function(a,b,c,d,e,f){var g,h,j;return j=new x.Util.Xhr(a,b),e.setRequestId&&(h="xxxxxxxxxxxxxxxx".replace(/x/g,function(){return Math.floor(16*Math.random()).toString(16)}),j.setHeader(Q,h)),_(null==c[$]),c=ab.clone(c),c[$]="dropbox-js-datastore-sdk/"+i,j.setParams(c),j.signWithOauth(this._oauth,!1),g=function(a,b){return null!=a?f(a):f(null,d.fromJSON(b))},e.isLongPoll?this._dispatchLongPollXhr(j,g):this._dispatchXhr(j,g),j},_listDatastores:function(a){return this._dispatchDatastoreXhr("GET",this._urls.listDbs,{},H,{},a)},_getOrCreateDatastore:function(a,b){return this._dispatchDatastoreXhr("POST",this._urls.getOrCreateDb,{dsid:a},g,{},b)},_createDatastore:function(a,b,c){return this._dispatchDatastoreXhr("POST",this._urls.createDb,{dsid:a,key:b},g,{},c)},_getDatastore:function(a,b){return this._dispatchDatastoreXhr("GET",this._urls.getDb,{dsid:a},D,{},b)},_deleteDatastore:function(a,b){return this._dispatchDatastoreXhr("POST",this._urls.deleteDb,{handle:a},v,{setRequestId:!0},b)},_putDelta:function(a,b,c){return this._dispatchDatastoreXhr("POST",this._urls.putDelta,{handle:a,rev:b.rev,nonce:b.nonce,changes:JSON.stringify(b.changes)},P,{setRequestId:!0},c)},_getSnapshot:function(a,b){return this._dispatchDatastoreXhr("GET",this._urls.getSnapshot,{handle:a},F,{},b)},_datastoreAwait:function(b,c,d){return this._dispatchDatastoreXhr("POST",this._urls.datastoreAwait,{get_deltas:JSON.stringify({cursors:b}),list_datastores:JSON.stringify({token:c})},a,{isLongPoll:!0,setRequestId:!0},d)},getDatastoreManager:function(){var a,b=this;return null==this._datastoreManager&&(this._datastoreManager=new x.Datastore.DatastoreManager(this),a=function(){return b.authStep===x.Client.SIGNED_OUT?(b._datastoreManager.close(),b._datastoreManager=null,b.onAuthStepChange.removeListener(a)):void 0},this.onAuthStepChange.addListener(a)),this._datastoreManager}},function(){var a,b,c,d;c=x.DatastoresClient,d=[];for(b in c)a=c[b],d.push(x.Client.prototype[b]=a);return d}()}).call(this),Vue.directive("highlight",{bind:function(){8===this.el.nodeType&&(this.nodes=[])},update:function(a){this.nodes?this.swap(a):this.el.innerHTML=a,$("pre code").each(function(a,b){hljs.highlightBlock(b)})},swap:function(a){for(var b=this.el.parentNode,c=this.nodes,d=c.length;d--;)b.removeChild(c[d]);var e=utils.toFragment(a);this.nodes=slice.call(e.childNodes),b.insertBefore(e,this.el)}});var vue=new Vue({el:"#content",data:{message:"```php\n$test = 'piyo';\n```\n# hoge\ntest. test. test.\n- list\n- list\n- list\n"},filters:{marked:marked},methods:{insert:function(a){if(9===a.keyCode)if(a.shiftKey===!1){a.preventDefault();var b=a.target,c=b.value,d=b.selectionStart;b.value=c.substr(0,d)+"	"+c.substr(d,c.length),b.setSelectionRange(d+1,d+1)}else{a.preventDefault();var b=a.target,c=b.value,d=b.selectionStart,e=c.substr(0,d).split("\n"),f=e.pop().replace(/^\t/,"");e=e.join("\n")+"\n"+f,b.value=e+c.substr(d,c.length),b.setSelectionRange(d-1,d-1)}}}}),separate=new Vue({el:"#separate",p:{separateX:0,previewWidth:0},methods:{onDragStart:function(a){this.separateX=a.x,this.previewWidth=parseInt($("#preview").css("width").replace("px","")),console.log("p = "+this.previewWidth);var b=document.createElement("img");b.src="images/1x1.gif",a.dataTransfer.setDragImage(b,-10,-10)},dragEnd:function(a){var b=this.separateX-a.x+this.previewWidth;$("#preview").css("width",b+"px"),$("#editor").css("width",a.x+"px"),$("#separate").css("left",a.x)},dragging:function(a){var b=this.separateX-a.x+this.previewWidth;$("#preview").css("width",b+"px"),$("#editor").css("width",a.x+"px"),$("#separate").css("left",a.x)}}});hljs.configure({classPrefix:""}),hljs.initHighlighting();